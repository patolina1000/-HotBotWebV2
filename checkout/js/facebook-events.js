/**
 * Facebook Pixel Events - Sistema Compartilhado
 * Fun√ß√µes reutiliz√°veis para eventos do Facebook Pixel nas p√°ginas de checkout
 * 
 * Baseado nas fun√ß√µes existentes do projeto:
 * - services/facebook.js (CAPI)
 * - MODELO1/WEB/tracking.js (Pixel)
 * - MODELO1/WEB/event-tracking-initiate.js (InitiateCheckout)
 */

(function() {
    'use strict';

    // Configura√ß√£o global
    const FacebookEvents = {
        initialized: false,
        pixelId: null,
        testMode: false,

        /**
         * Inicializa o sistema de eventos do Facebook
         */
        init() {
            if (this.initialized) {
                console.log('üìä [FACEBOOK-EVENTS] J√° inicializado');
                return;
            }

            console.log('üìä [FACEBOOK-EVENTS] Inicializando sistema de eventos...');

            // Aguardar o carregamento do Facebook Pixel
            const checkFbq = () => {
                if (typeof fbq !== 'undefined') {
                    this.initialized = true;
                    console.log('üìä [FACEBOOK-EVENTS] Sistema inicializado com sucesso');
                } else {
                    // Tentar novamente em 100ms
                    setTimeout(checkFbq, 100);
                }
            };

            checkFbq();
        },

        /**
         * Gera um Event ID √∫nico para deduplica√ß√£o
         */
        generateEventId(eventName, prefix = 'checkout') {
            const timestamp = Date.now();
            const random = Math.random().toString(36).substring(2, 15);
            return `${prefix}_${eventName}_${timestamp}_${random}`;
        },

        /**
         * Captura cookies do Facebook se dispon√≠veis
         */
        getFacebookCookies() {
            const cookies = {};
            
            // Capturar _fbp
            const fbpMatch = document.cookie.match(/_fbp=([^;]+)/);
            if (fbpMatch) {
                cookies.fbp = fbpMatch[1];
            }

            // Capturar _fbc
            const fbcMatch = document.cookie.match(/_fbc=([^;]+)/);
            if (fbcMatch) {
                cookies.fbc = fbcMatch[1];
            }

            return cookies;
        },

        /**
         * Evento PageView - Disparado quando a p√°gina carrega
         */
        trackPageView() {
            if (!this.initialized || typeof fbq === 'undefined') {
                console.warn('üìä [FACEBOOK-EVENTS] Sistema n√£o inicializado ou fbq n√£o dispon√≠vel');
                return;
            }

            try {
                console.log('üìä [FACEBOOK-EVENTS] Disparando PageView...');
                
                // Disparar evento PageView padr√£o do Facebook Pixel
                fbq('track', 'PageView');
                
                console.log('üìä [FACEBOOK-EVENTS] ‚úÖ PageView enviado com sucesso');
                
            } catch (error) {
                console.error('üìä [FACEBOOK-EVENTS] ‚ùå Erro ao enviar PageView:', error);
            }
        },

        /**
         * Evento ViewContent - Disparado ap√≥s 3 segundos na p√°gina
         */
        trackViewContent(value = null, contentName = null, contentCategory = null) {
            if (!this.initialized || typeof fbq === 'undefined') {
                console.warn('üìä [FACEBOOK-EVENTS] Sistema n√£o inicializado ou fbq n√£o dispon√≠vel');
                return;
            }

            try {
                console.log('üìä [FACEBOOK-EVENTS] Disparando ViewContent...');
                
                const eventData = {
                    content_name: contentName || 'P√°gina de Checkout',
                    content_category: contentCategory || 'E-commerce'
                };

                // Adicionar valor se fornecido
                if (value && typeof value === 'number') {
                    eventData.value = value;
                    eventData.currency = 'BRL';
                }

                // Disparar evento ViewContent
                fbq('track', 'ViewContent', eventData);
                
                console.log('üìä [FACEBOOK-EVENTS] ‚úÖ ViewContent enviado com sucesso', eventData);
                
            } catch (error) {
                console.error('üìä [FACEBOOK-EVENTS] ‚ùå Erro ao enviar ViewContent:', error);
            }
        },

        /**
         * Normaliza email para envio ao Pixel (lowercase, trim)
         */
        normalizeEmail(email) {
            if (!email || typeof email !== 'string') return null;
            return email.trim().toLowerCase() || null;
        },

        /**
         * Normaliza telefone para envio ao Pixel (apenas d√≠gitos com DDI)
         */
        normalizePhone(phone) {
            if (!phone || typeof phone !== 'string') return null;
            const digits = phone.replace(/\D/g, '');
            if (!digits) return null;
            // Adicionar DDI 55 se for BR e n√£o tiver
            if (digits.length === 11 || digits.length === 10) {
                return '55' + digits;
            }
            return digits;
        },

        /**
         * Normaliza nome para envio ao Pixel (lowercase, trim, sem acentos)
         */
        normalizeName(name) {
            if (!name || typeof name !== 'string') return null;
            return name.trim()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/[^\w\s'-]+/g, '')
                .toLowerCase() || null;
        },

        /**
         * Evento InitiateCheckout - Disparado quando usu√°rio clica para gerar PIX
         * Reutiliza a l√≥gica existente do projeto
         */
        trackInitiateCheckout(value, currency = 'BRL', contentName = null, contentCategory = null, userData = {}) {
            if (!this.initialized || typeof fbq === 'undefined') {
                console.warn('üìä [FACEBOOK-EVENTS] Sistema n√£o inicializado ou fbq n√£o dispon√≠vel');
                return;
            }

            try {
                console.log('üìä [FACEBOOK-EVENTS] Disparando InitiateCheckout...');
                
                const eventId = this.generateEventId('InitiateCheckout');
                const cookies = this.getFacebookCookies();
                
                const eventData = {
                    value: value,
                    currency: currency,
                    content_name: contentName || 'Produto',
                    content_category: contentCategory || 'E-commerce',
                    eventID: eventId
                };

                // Adicionar cookies se dispon√≠veis
                if (cookies.fbp) eventData._fbp = cookies.fbp;
                if (cookies.fbc) eventData._fbc = cookies.fbc;

                // üéØ ADVANCED MATCHING - Plain-text (n√£o hashear no browser)
                // O Meta Pixel faz o hashing autom√°tico
                if (userData.email) {
                    const normalizedEmail = this.normalizeEmail(userData.email);
                    if (normalizedEmail) {
                        eventData.em = normalizedEmail;
                        console.log('üìä [FACEBOOK-EVENTS] Advanced Matching: email inclu√≠do (plain-text)');
                    }
                }
                if (userData.phone) {
                    const normalizedPhone = this.normalizePhone(userData.phone);
                    if (normalizedPhone) {
                        eventData.ph = normalizedPhone;
                        console.log('üìä [FACEBOOK-EVENTS] Advanced Matching: phone inclu√≠do (plain-text)');
                    }
                }
                if (userData.firstName) {
                    const normalizedFn = this.normalizeName(userData.firstName);
                    if (normalizedFn) {
                        eventData.fn = normalizedFn;
                        console.log('üìä [FACEBOOK-EVENTS] Advanced Matching: firstName inclu√≠do (plain-text)');
                    }
                }
                if (userData.lastName) {
                    const normalizedLn = this.normalizeName(userData.lastName);
                    if (normalizedLn) {
                        eventData.ln = normalizedLn;
                        console.log('üìä [FACEBOOK-EVENTS] Advanced Matching: lastName inclu√≠do (plain-text)');
                    }
                }
                if (userData.externalId) {
                    eventData.external_id = String(userData.externalId);
                    console.log('üìä [FACEBOOK-EVENTS] Advanced Matching: external_id inclu√≠do (plain-text)');
                }

                // Disparar evento InitiateCheckout
                fbq('track', 'InitiateCheckout', eventData);
                
                // Armazenar eventID para uso posterior (seguindo padr√£o do projeto)
                localStorage.setItem('checkout_event_id', eventId);
                
                console.log('üìä [FACEBOOK-EVENTS] ‚úÖ InitiateCheckout enviado com sucesso', {
                    eventId: eventId,
                    value: value,
                    currency: currency,
                    hasAdvancedMatching: !!(userData.email || userData.phone || userData.firstName || userData.lastName)
                });
                
                return { success: true, eventId: eventId };
                
            } catch (error) {
                console.error('üìä [FACEBOOK-EVENTS] ‚ùå Erro ao enviar InitiateCheckout:', error);
                return { success: false, error: error.message };
            }
        },

        /**
         * Evento Purchase - Disparado quando pagamento √© confirmado
         * Reutiliza a l√≥gica existente do projeto
         */
        trackPurchase(transactionId, value, currency = 'BRL', contentName = null, userData = {}) {
            if (!this.initialized || typeof fbq === 'undefined') {
                console.warn('üìä [FACEBOOK-EVENTS] Sistema n√£o inicializado ou fbq n√£o dispon√≠vel');
                return;
            }

            try {
                console.log('üìä [FACEBOOK-EVENTS] Disparando Purchase...');
                
                const eventId = this.generateEventId('Purchase', transactionId);
                const cookies = this.getFacebookCookies();
                
                const eventData = {
                    value: value,
                    currency: currency,
                    content_name: contentName || 'Compra Realizada',
                    content_type: 'product',
                    eventID: eventId
                };

                // Adicionar cookies se dispon√≠veis
                if (cookies.fbp) eventData._fbp = cookies.fbp;
                if (cookies.fbc) eventData._fbc = cookies.fbc;

                // üéØ ADVANCED MATCHING - Plain-text (n√£o hashear no browser)
                // O Meta Pixel faz o hashing autom√°tico
                if (userData.email) {
                    const normalizedEmail = this.normalizeEmail(userData.email);
                    if (normalizedEmail) {
                        eventData.em = normalizedEmail;
                        console.log('üìä [FACEBOOK-EVENTS] Advanced Matching: email inclu√≠do (plain-text)');
                    }
                }
                if (userData.phone) {
                    const normalizedPhone = this.normalizePhone(userData.phone);
                    if (normalizedPhone) {
                        eventData.ph = normalizedPhone;
                        console.log('üìä [FACEBOOK-EVENTS] Advanced Matching: phone inclu√≠do (plain-text)');
                    }
                }
                if (userData.firstName) {
                    const normalizedFn = this.normalizeName(userData.firstName);
                    if (normalizedFn) {
                        eventData.fn = normalizedFn;
                        console.log('üìä [FACEBOOK-EVENTS] Advanced Matching: firstName inclu√≠do (plain-text)');
                    }
                }
                if (userData.lastName) {
                    const normalizedLn = this.normalizeName(userData.lastName);
                    if (normalizedLn) {
                        eventData.ln = normalizedLn;
                        console.log('üìä [FACEBOOK-EVENTS] Advanced Matching: lastName inclu√≠do (plain-text)');
                    }
                }
                if (userData.externalId) {
                    eventData.external_id = String(userData.externalId);
                    console.log('üìä [FACEBOOK-EVENTS] Advanced Matching: external_id inclu√≠do (plain-text)');
                }

                // Disparar evento Purchase
                fbq('track', 'Purchase', eventData);
                
                console.log('üìä [FACEBOOK-EVENTS] ‚úÖ Purchase enviado com sucesso', {
                    eventId: eventId,
                    transactionId: transactionId,
                    value: value,
                    currency: currency,
                    hasAdvancedMatching: !!(userData.email || userData.phone || userData.firstName || userData.lastName)
                });
                
                return { success: true, eventId: eventId };
                
            } catch (error) {
                console.error('üìä [FACEBOOK-EVENTS] ‚ùå Erro ao enviar Purchase:', error);
                return { success: false, error: error.message };
            }
        }
    };

    // Auto-inicializar quando DOM estiver pronto
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            // Aguardar um pouco mais para garantir que o Facebook Pixel carregou
            setTimeout(() => {
                FacebookEvents.init();
            }, 500);
        });
    } else {
        // Aguardar um pouco mais para garantir que o Facebook Pixel carregou
        setTimeout(() => {
            FacebookEvents.init();
        }, 500);
    }

    // Expor API globalmente
    window.FacebookEvents = FacebookEvents;
    
    // Compatibilidade com sistemas existentes
    window.trackFacebookPageView = () => FacebookEvents.trackPageView();
    window.trackFacebookViewContent = (value, name, category) => FacebookEvents.trackViewContent(value, name, category);
    window.trackFacebookInitiateCheckout = (value, currency, name, category, userData) => FacebookEvents.trackInitiateCheckout(value, currency, name, category, userData);
    window.trackFacebookPurchase = (transactionId, value, currency, name, userData) => FacebookEvents.trackPurchase(transactionId, value, currency, name, userData);

    console.log('üìä [FACEBOOK-EVENTS] Script carregado - API dispon√≠vel em window.FacebookEvents');

})();
