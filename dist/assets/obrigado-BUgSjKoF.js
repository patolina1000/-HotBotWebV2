import{q as b}from"./thumbmark.esm-DVxj7phU.js";console.log("🚀 [OBRIGADO] Script obrigado.js carregado!");console.log("🚀 [OBRIGADO] Timestamp:",new Date().toISOString());console.log("🚀 [OBRIGADO] User Agent:",navigator.userAgent);console.log("🚀 [OBRIGADO] URL atual:",window.location.href);console.log("🚀 [OBRIGADO] Cookies disponíveis:",document.cookie);console.log("🚀 [OBRIGADO] localStorage disponível:",typeof localStorage<"u");async function m(){try{const a=new b,{id:e}=await a.get();return console.log("✅ Thumbmark ID via bundle:",e),e}catch(a){console.warn("⚠️ [THUMBMARK] Erro ao gerar ID via bundle, usando UUID fallback:",a);const e=typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():I();return console.log("✅ [THUMBMARK] ID gerado:",e),e}}async function k(){const a=document.getElementById("status-text");if(!a)return;try{const n=await(await fetch("https://pro.ip-api.com/json/?key=R1a8D9VJfrqTqpY&fields=status,country,countryCode,region,city")).json();if(n.status==="success"&&n.city){a.textContent=`ONLINE AGORA · ${n.city}`,console.log("Cidade detectada:",n.city);return}}catch(o){console.log("Erro na API principal, tentando fallbacks:",o)}const e=[{url:"https://ipinfo.io/json",parse:o=>o.city},{url:"https://ipapi.co/json/",parse:o=>o.error?null:o.city},{url:"https://geolocation-db.com/json/",parse:o=>o.city&&o.city!=="Not found"?o.city:null}];for(const o of e)try{const n=await fetch(o.url,{headers:{Accept:"application/json"}});if(!n.ok)continue;const t=await n.json(),s=o.parse(t);if(s){a.textContent=`ONLINE AGORA · ${s}`,console.log("Cidade detectada via fallback:",s);return}}catch{}a.textContent="ONLINE AGORA",console.log("Fallback: Cidade não detectada")}function g(a){const e=`; ${document.cookie}`,n={_fbp:["_fbp","fbp"],fbp:["_fbp","fbp"],_fbc:["_fbc","fbc"],fbc:["_fbc","fbc"]}[a]||[a];for(const t of n){const s=new RegExp(`(?:^|; )${t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}=([^;]*)`),r=document.cookie.match(s);if(r){const l=decodeURIComponent(r[1]);if(l)return console.log(`✅ [OBRIGADO] Cookie ${t} encontrado:`,l),l}}for(const t of n){const s=e.split(`; ${t}=`);if(s.length>=2){const r=s[s.length-1].split(";")[0];if(r&&r.trim())return console.log(`✅ [OBRIGADO] Cookie ${t} encontrado (fallback):`,r),decodeURIComponent(r)}}return console.log(`❌ [OBRIGADO] Cookie ${a} não encontrado. Variantes testadas:`,n),null}function p(a){return`fb.1.${Date.now()}.${a}`}function f(){return Math.floor(Math.random()*1e10)}function w(){try{const a=document.createElement("canvas"),e=a.getContext("2d");return e.textBaseline="top",e.font="14px Arial",e.fillText("Canvas fingerprint",2,2),a.toDataURL().slice(-50)}catch(a){return console.warn("Canvas hash generation failed:",a),"canvas_unavailable"}}function I(){return crypto&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){const e=Math.random()*16|0;return(a=="x"?e:e&3|8).toString(16)})}async function O(a){try{console.log("🔍 [TRACKING] Iniciando recuperarTrackingWhatsApp para token:",a?a.substring(0,8)+"...":"N/A");const e=await m();console.log("🔑 [TRACKING] Thumbmark ID utilizado:",e?e.substring(0,8)+"...":null);let o=null;try{o=(await(await fetch("https://api.ipify.org?format=json")).json()).ip,console.log("🌍 [TRACKING] IP capturado:",o)}catch(l){console.warn("⚠️ [TRACKING] Falha ao capturar IP, tentando fallback:",l);try{o=(await(await fetch("https://httpbin.org/ip")).json()).origin,console.log("🌍 [TRACKING] IP capturado via fallback:",o)}catch(i){console.warn("⚠️ [TRACKING] Falha no fallback de IP, usando IP padrão:",i),o="0.0.0.0"}}const n=navigator.userAgent;if(!o||!n)return console.error("❌ [TRACKING] Dados obrigatórios ausentes para recuperar tracking:",{ip:o,user_agent:n?"presente":"ausente"}),null;const t={ip:o,user_agent:n,thumbmark_id:e,token:a};console.log("📤 [TRACKING] Enviando payload para /api/whatsapp/recuperar-tracking:",{ip:o,thumbmark_id:e?e.substring(0,8)+"...":null,token:a?a.substring(0,8)+"...":null});const r=await(await fetch("/api/whatsapp/recuperar-tracking",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).json();if(r.success){console.log("✅ [TRACKING] Match encontrado! UTMs:",r.utms),r.fbp&&(c.fbp=r.fbp,console.log("🔄 [TRACKING] FBP atualizado:",r.fbp.substring(0,20)+"...")),r.fbc&&(c.fbc=r.fbc,console.log("🔄 [TRACKING] FBC atualizado:",r.fbc.substring(0,20)+"...")),r.utms&&(c.utms=r.utms,console.log("🔄 [TRACKING] UTMs atualizadas:",r.utms)),r.city&&(c.city=r.city,console.log("🔄 [TRACKING] Cidade atualizada:",r.city));const l=typeof window<"u"&&window.trackingData?window.trackingData:{};return window.trackingData={...l,...c,utms:r.utms||l.utms||c.utms||null,fbp:r.fbp||l.fbp||c.fbp||null,fbc:r.fbc||l.fbc||c.fbc||null,city:r.city||l.city||c.city||null,ip:r.ip||l.ip||c.ip||null,userAgent:r.userAgent||l.userAgent||c.userAgent||null},console.log("🌍 [TRACKING] Dados disponibilizados globalmente:",window.trackingData),r}else return console.warn("⚠️ [TRACKING] Nenhum match encontrado, usando fallback localStorage/URL."),null}catch(e){return console.error("❌ [TRACKING] Erro ao recuperar tracking WhatsApp:",e),null}}let c={};function A(){try{const o=localStorage.getItem("trackingData");console.log("🔍 [OBRIGADO] Dados brutos do localStorage:",o),o?(c=JSON.parse(o)||{},console.log("📥 [OBRIGADO] Tracking data carregado do localStorage:",c),console.log("📥 [OBRIGADO] FBP carregado:",c.fbp),console.log("📥 [OBRIGADO] FBC carregado:",c.fbc)):(c={},console.log("ℹ️ [OBRIGADO] Nenhum tracking data encontrado no localStorage."))}catch(o){console.error("❌ [OBRIGADO] Erro ao carregar tracking data do localStorage:",o),c={}}const e=new URLSearchParams(window.location.search).get("fbclid");if(!c.fbp){let o=g("_fbp");o||(o=p(f())),c.fbp=o,console.log("🔄 FBP corrigido com fallback:",o)}if(!c.fbc){let o=g("_fbc");console.log("🔍 [OBRIGADO] FBC do cookie atual:",o),o?console.log("✅ [OBRIGADO] Usando FBC existente do cookie:",o):e?(o=p(e),console.log("🔄 [OBRIGADO] FBC gerado com fbclid:",o)):(o=p(f()),console.log("🔄 [OBRIGADO] FBC gerado como fallback:",o)),c.fbc=o}return c}function y(){const e=["assets/background.jpg","assets/perfil.jpg"].map(o=>new Promise((n,t)=>{const s=new Image;s.onload=()=>{console.log(`Imagem carregada: ${o}`),n({src:o,success:!0})},s.onerror=()=>{console.warn(`Falha ao carregar imagem: ${o}`),n({src:o,success:!1})},s.src=o}));return Promise.all(e)}function R(a){const e=document.querySelector(".avatar");if(!e)return;const o=a.find(n=>n.src==="assets/perfil.jpg");o&&!o.success&&(console.log("Aplicando fallback para avatar"),e.classList.add("fallback"))}async function D(){try{console.log("🚀 [OBRIGADO] Coletando sinais para envio ao backend...");const a=await m();console.log("🔑 [TRACKING] Thumbmark ID utilizado para recuperação:",a?a.substring(0,8)+"...":null);const e=window.screen.width+"x"+window.screen.height,o=navigator.hardwareConcurrency||"unknown",n=w(),t=navigator.userAgent,s=Date.now(),l=new URLSearchParams(window.location.search).get("token")||null,i={thumbmark_id:a,screen_resolution:e,hardware_concurrency:o,canvas_hash:n,user_agent:t,timestamp:s,purchaseToken:l};console.log("📊 [OBRIGADO] Sinais coletados:",{thumbmark_id:a?a.substring(0,8)+"...":null,screen_resolution:e,hardware_concurrency:o,canvas_hash:n.substring(0,10)+"...",user_agent:t.substring(0,50)+"...",timestamp:s,purchaseToken:l?l.substring(0,8)+"...":null}),console.log("📤 [OBRIGADO] Enviando dados para /api/track-obrigado...");const u=await fetch("/api/track-obrigado",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});if(u.ok){const h=await u.json();console.log("✅ [OBRIGADO] Dados enviados com sucesso para /api/track-obrigado:",h)}else console.warn("⚠️ [OBRIGADO] Falha ao enviar dados para /api/track-obrigado:",u.status,u.statusText),console.log("🔄 [OBRIGADO] Continuando fluxo normal mesmo com falha no backend")}catch(a){console.error("❌ [OBRIGADO] Erro ao coletar/enviar sinais:",a),console.log("🔄 [OBRIGADO] Continuando fluxo normal mesmo com erro na coleta")}}async function T(a){try{console.log("📝 Marcando token como usado..."),(await fetch("/api/whatsapp/marcar-usado",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:a})})).ok?console.log("✅ Token marcado como usado com sucesso!"):console.log("⚠️ Falha ao marcar token como usado")}catch(e){console.error("❌ Erro ao marcar token como usado:",e)}}async function v(a,e=null){try{const n=new URLSearchParams(window.location.search).get("token");if(!n){console.log("❌ Token não encontrado para envio do evento Purchase");return}if(typeof window.whatsappTracking<"u"&&typeof window.whatsappTracking.trackPurchase=="function"){console.log("📊 Enviando evento Purchase para Facebook...");const t=e||{productId:"whatsapp-premium",planId:"whatsapp-premium-plan",produto:"WhatsApp Premium",plano:"Plano Premium WhatsApp",content_name:"WhatsApp Premium Access",content_category:"premium_content"};console.log("📊 [OBRIGADO] Dados do cliente/produto incluídos:",t);const s=await window.whatsappTracking.trackPurchase(n,a,t);console.log(s?"✅ Evento Purchase enviado com sucesso!":"⚠️ Falha ao enviar evento Purchase")}else console.log("⚠️ Função trackPurchase não disponível")}catch(o){console.error("❌ Erro ao enviar evento Purchase:",o)}}async function G(){const e=new URLSearchParams(window.location.search).get("token");if(console.log(`📌 Token detectado: ${e}`),console.log("🔎 Tracking data disponível antes da verificação:",c),!e){console.log("❌ Token não encontrado"),d("Token não encontrado na URL.");return}try{const o={token:e,fbp:c?.fbp||null,fbc:c?.fbc||null,user_agent:c?.userAgent||null,ip:c?.ip||null,city:c?.city||null,client_timestamp:Math.floor(Date.now()/1e3),event_source_url:window.location.href};console.log("📦 [OBRIGADO] Payload enviado para verificação:",o),console.log("📦 [OBRIGADO] FBP no payload:",o.fbp),console.log("📦 [OBRIGADO] FBC no payload:",o.fbc),console.log("📦 [OBRIGADO] TrackingData completo:",c);const n=await fetch("/api/whatsapp/verificar-token",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});let t={};try{t=await n.json()}catch(s){console.error("Erro ao processar resposta JSON:",s)}if(console.log("Resposta da API:",t),!n.ok){console.log("❌ Erro da API:",t.erro||n.statusText),setTimeout(()=>{d(t.erro||"Erro ao acessar API")},2e3);return}if(t.sucesso===!0){console.log("✅ Token validado com sucesso!");const s={first_name:t.first_name||null,last_name:t.last_name||null,phone:t.phone||null,productId:"whatsapp-premium",planId:"whatsapp-premium-plan",produto:"WhatsApp Premium",plano:"Plano Premium WhatsApp",content_name:"WhatsApp Premium Access",content_category:"premium_content"};console.log("📊 [OBRIGADO] Dados do cliente recebidos do backend:",{first_name:t.first_name,last_name:t.last_name,phone:t.phone,valor:t.valor}),await v(t.valor,s),await T(e),setTimeout(()=>{window.location.href="https://www.google.com/?hl=pt_BR"},2e3)}else console.log("❌ Token inválido ou já utilizado"),setTimeout(()=>{d("Token inválido ou já foi usado.")},2e3)}catch(o){console.error("Erro ao verificar token:",o),setTimeout(()=>{d("Erro de conexão. Tente novamente.")},2e3)}}function d(a="Token inválido ou já foi usado."){document.getElementById("loading").classList.add("hidden"),document.getElementById("erro").classList.remove("hidden"),document.getElementById("erro-mensagem").textContent=a,setTimeout(()=>{window.location.href="/whatsapp"},4e3)}document.addEventListener("DOMContentLoaded",async function(){console.log("🎉 [OBRIGADO] Página de agradecimento carregada"),console.log("🎉 [OBRIGADO] Timestamp:",new Date().toISOString()),console.log("🎉 [OBRIGADO] URL atual:",window.location.href),console.log("🎉 [OBRIGADO] Cookies disponíveis:",document.cookie);const a=await y();R(a),k(),A(),await D();const o=new URLSearchParams(window.location.search).get("token");o&&(console.log("🔍 [OBRIGADO] Recuperando tracking para token:",o.substring(0,8)+"..."),await O(o)),G(),console.log("✅ Página de agradecimento configurada com sucesso")});
