import{q as D}from"./thumbmark.esm-DVxj7phU.js";console.log("🚀 [REDIRECT] Script redirect.js carregado!");console.log("🚀 [REDIRECT] Timestamp:",new Date().toISOString());console.log("🚀 [REDIRECT] User Agent:",navigator.userAgent);console.log("🚀 [REDIRECT] URL atual:",window.location.href);console.log("🚀 [REDIRECT] Cookies disponíveis:",document.cookie);console.log("🚀 [REDIRECT] localStorage disponível:",typeof localStorage<"u");async function w(){try{const g=new D,{id:p}=await g.get();return console.log("✅ Thumbmark ID via bundle:",p),p}catch(g){console.warn("⚠️ [THUMBMARK] Erro ao gerar ID via bundle, usando UUID fallback:",g);const p=typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():generateUUID();return console.log("✅ [THUMBMARK] ID gerado:",p),p}}try{let p=function(n){const e=`; ${document.cookie}`,o={_fbp:["_fbp","fbp"],fbp:["_fbp","fbp"],_fbc:["_fbc","fbc"],fbc:["_fbc","fbc"]}[n]||[n];for(const a of o){const r=new RegExp(`(?:^|; )${a.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}=([^;]*)`),s=document.cookie.match(r);if(s){const u=decodeURIComponent(s[1]);if(u)return console.log(`✅ [REDIRECT] Cookie ${a} encontrado:`,u),u}}for(const a of o){const r=e.split(`; ${a}=`);if(r.length>=2){const s=r[r.length-1].split(";")[0];if(s&&s.trim())return console.log(`✅ [REDIRECT] Cookie ${a} encontrado (fallback):`,s),decodeURIComponent(s)}}return console.log(`❌ [REDIRECT] Cookie ${n} não encontrado. Variantes testadas:`,o),console.log("🔍 [REDIRECT] Cookies brutos para debug:",document.cookie),null},R=function(n,e,t=90){const o=new Date;o.setTime(o.getTime()+t*24*60*60*1e3);const a=o.toUTCString();document.cookie=`${n}=${e}; expires=${a}; path=/; SameSite=Lax`,console.log(`🍪 [REDIRECT] Cookie ${n} criado:`,e)},m=function(n){return`fb.1.${Date.now()}.${n}`},E=function(){return Math.floor(Math.random()*1e10)},h=function(){try{const n=document.createElement("canvas"),e=n.getContext("2d");return e.textBaseline="top",e.font="14px Arial",e.fillText("Canvas fingerprint",2,2),n.toDataURL().slice(-50)}catch(n){return console.warn("Canvas hash generation failed:",n),"canvas_unavailable"}},x=function(){return crypto&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){const e=Math.random()*16|0;return(n=="x"?e:e&3|8).toString(16)})},I=function(){const e=["assets/background.jpg","assets/perfil.jpg"].map(t=>new Promise((o,a)=>{const r=new Image;r.onload=()=>{console.log(`Imagem carregada: ${t}`),o({src:t,success:!0})},r.onerror=()=>{console.warn(`Falha ao carregar imagem: ${t}`),o({src:t,success:!1})},r.src=t}));return Promise.all(e)},k=function(n){const e=document.querySelector(".avatar");if(!e)return;const t=n.find(o=>o.src==="assets/perfil.jpg");t&&!t.success&&(console.log("Aplicando fallback para avatar"),e.classList.add("fallback"))},y=function(){if(typeof window.zapLink>"u"){console.warn("⚠️ [REDIRECT] window.zapLink não encontrado - página pode ter sido acessada diretamente");const n=window.location.pathname,e=window.location.search;if(n.includes("/redirect.html")||n.endsWith(".html")){console.log("🔄 [REDIRECT] Redirecionando para rota correta /whatsapp...");const t=new URLSearchParams(e),o=`/whatsapp${e}`;return window.location.href=o,!1}}return!0};async function g(){const n=document.getElementById("status-text");if(!n)return;try{const o=await(await fetch("https://pro.ip-api.com/json/?key=R1a8D9VJfrqTqpY&fields=status,country,countryCode,region,city")).json();if(o.status==="success"&&o.city){n.textContent=`ONLINE AGORA · ${o.city}`,console.log("Cidade detectada:",o.city);return}}catch(t){console.log("Erro na API principal, tentando fallbacks:",t)}const e=[{url:"https://ipinfo.io/json",parse:t=>t.city},{url:"https://ipapi.co/json/",parse:t=>t.error?null:t.city},{url:"https://geolocation-db.com/json/",parse:t=>t.city&&t.city!=="Not found"?t.city:null}];for(const t of e)try{const o=await fetch(t.url,{headers:{Accept:"application/json"}});if(!o.ok)continue;const a=await o.json(),r=t.parse(a);if(r){n.textContent=`ONLINE AGORA · ${r}`,console.log("Cidade detectada via fallback:",r);return}}catch{}n.textContent="ONLINE AGORA",console.log("Fallback: Cidade não detectada")}async function b(n){try{console.log("🔍 [TRACKING] Iniciando salvarSessaoWhatsApp...");const e=await w();console.log("🔑 [TRACKING] Thumbmark ID utilizado:",e?e.substring(0,8)+"...":null);const t=m(Date.now()+Math.random().toString(36).slice(2)),o=new URLSearchParams(window.location.search),a={utm_source:o.get("utm_source")||null,utm_medium:o.get("utm_medium")||null,utm_campaign:o.get("utm_campaign")||null,utm_content:o.get("utm_content")||null,utm_term:o.get("utm_term")||null,fbclid:o.get("fbclid")||null},r=window.screen.width+"x"+window.screen.height,s=navigator.hardwareConcurrency||"unknown",u=h(),C={session_id:t,ip:n.ip,user_agent:n.userAgent,thumbmark_id:e,utms:a,fbp:n.fbp,fbc:n.fbc,city:n.city,screen_resolution:r,hardware_concurrency:s,canvas_hash:u};console.log("📤 [TRACKING] Enviando payload para /api/track-redirect:",{thumbmark_id:e?e.substring(0,8)+"...":null,ip:n.ip,utms:a,fbclid:a.fbclid,screen_resolution:r,hardware_concurrency:s,canvas_hash:u.substring(0,10)+"..."});const f=await fetch("/api/track-redirect",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({thumbmark_id:e,utms:a,fbclid:a.fbclid,ip:n.ip,screen_resolution:r,hardware_concurrency:s,canvas_hash:u,user_agent:n.userAgent})});f.ok?console.log("✅ [TRACKING] Sessão salva com thumbmark",e?e.substring(0,8)+"...":"N/A"):console.warn("⚠️ [TRACKING] Falha ao salvar sessão:",f.status,f.statusText)}catch(e){console.error("❌ [TRACKING] Erro ao salvar sessão WhatsApp:",e)}}async function T(){console.log("🚀 [REDIRECT] captureTrackingData() INICIADA"),console.log("Cookies brutos:",document.cookie);const n=new URLSearchParams(window.location.search),e=n.get("fbclid"),t=n.get("token");console.log("FBCLID da URL:",e);let o=p("_fbp");console.log("🔍 [REDIRECT] FBP do cookie:",o),o||(o=m(E()),R("_fbp",o,90),console.log("🔄 [REDIRECT] FBP gerado como fallback:",o)),console.log("✅ [REDIRECT] FBP final:",o);let a=p("_fbc");console.log("🔍 [REDIRECT] FBC do cookie:",a),a?console.log("✅ [REDIRECT] Usando FBC existente do cookie:",a):e?(a=m(e),R("_fbc",a,90),console.log("🔄 [REDIRECT] FBC gerado com fbclid:",a)):(a=m(E()),R("_fbc",a,90),console.log("🔄 [REDIRECT] FBC gerado como fallback:",a)),console.log("✅ [REDIRECT] FBC final:",a);const r=navigator.userAgent||null;console.log("🧭 User Agent capturado:",r);const s=await w();console.log("🔑 [REDIRECT] Thumbmark ID obtido:",s?s.substring(0,8)+"...":null);const u=window.screen.width+"x"+window.screen.height,C=navigator.hardwareConcurrency||"unknown",f=h(),i={fbp:o,fbc:a,userAgent:r,thumbmark_id:s,screen_resolution:u,hardware_concurrency:C,canvas_hash:f,ip:null,city:null};try{const l=await fetch("https://pro.ip-api.com/json/?key=R1a8D9VJfrqTqpY&fields=status,country,countryCode,region,city,query"),d=await l.json();l.ok&&d.status==="success"?(i.ip=d.query||null,i.city=d.city||null,console.log("🌍 Dados de geolocalização capturados:",{ip:i.ip,city:i.city})):console.warn("⚠️ Falha ao capturar dados de geolocalização:",d)}catch(l){console.error("❌ Erro ao capturar dados de geolocalização:",l)}const c={fbp:i.fbp,fbc:i.fbc,userAgent:i.userAgent,thumbmark_id:i.thumbmark_id,screen_resolution:i.screen_resolution,hardware_concurrency:i.hardware_concurrency,canvas_hash:i.canvas_hash,ip:i.ip,city:i.city};try{localStorage.setItem("trackingData",JSON.stringify(c)),console.log("✅ [REDIRECT] Tracking salvo no localStorage:",c),console.log("✅ [REDIRECT] FBP salvo:",c.fbp),console.log("✅ [REDIRECT] FBC salvo:",c.fbc),console.log("✅ [REDIRECT] Thumbmark ID salvo:",c.thumbmark_id?c.thumbmark_id.substring(0,8)+"...":null),console.log("✅ [REDIRECT] Screen resolution:",c.screen_resolution),console.log("✅ [REDIRECT] Hardware concurrency:",c.hardware_concurrency);const l=localStorage.getItem("trackingData");console.log("✅ [REDIRECT] Verificação localStorage:",l)}catch(l){console.error("❌ Erro ao salvar tracking data no localStorage:",l)}if(t){const l={token:t,trackingData:c};try{console.log("📤 [REDIRECT] Enviando dados com token para backend:",l);const d=await fetch("/api/whatsapp/salvar-tracking",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)});d.ok?console.log("✅ [REDIRECT] Tracking com token enviado com sucesso"):console.warn("⚠️ [REDIRECT] Falha ao enviar tracking com token para o backend:",d.status,d.statusText)}catch(d){console.error("❌ [REDIRECT] Erro ao enviar tracking com token para o backend:",d)}}else console.log("ℹ️ [REDIRECT] Token não encontrado, mas dados de tracking foram capturados:",c),console.log("📊 [REDIRECT] FBP capturado:",c.fbp),console.log("📊 [REDIRECT] FBC capturado:",c.fbc),console.log("📊 [REDIRECT] Thumbmark ID capturado:",c.thumbmark_id?c.thumbmark_id.substring(0,8)+"...":null),console.log("📊 [REDIRECT] Screen resolution capturado:",c.screen_resolution),console.log("📊 [REDIRECT] Hardware concurrency capturado:",c.hardware_concurrency),console.log("📊 [REDIRECT] IP capturado:",c.ip),console.log("📊 [REDIRECT] UserAgent capturado:",c.userAgent?c.userAgent.substring(0,50)+"...":"null");return c}document.addEventListener("DOMContentLoaded",async function(){if(console.log("🎉 [REDIRECT] DOMContentLoaded - Página carregada"),!y())return;const n=await I();k(n),g(),console.log("⏰ [REDIRECT] Iniciando setTimeout de 3.5 segundos..."),setTimeout(async function(){console.log("⏰ [REDIRECT] setTimeout executado após 3.5 segundos");const e=window.zapLink;if(console.log("🔍 [REDIRECT] zapLink encontrado:",e),console.log("🔍 [REDIRECT] window.zapLink:",window.zapLink),e&&e!=="undefined"&&e.trim()!==""){console.log("✅ [REDIRECT] Executando captureTrackingData...");const t=await T();console.log("✅ [REDIRECT] captureTrackingData concluído, salvando sessão..."),await b(t),console.log("✅ [REDIRECT] Sessão salva, redirecionando..."),window.location.href=e}else if(console.error("❌ [REDIRECT] Link do WhatsApp não encontrado ou inválido"),console.error("❌ [REDIRECT] zapLink value:",e),console.error("❌ [REDIRECT] typeof zapLink:",typeof e),window.reloadAttempted)document.querySelector(".loading-text").innerHTML=`
                    <div style="color: #ff6b6b; margin-bottom: 15px;">⚠️ Erro de Configuração</div>
                    <div style="font-size: 0.9rem; line-height: 1.4;">
                        Link do WhatsApp não encontrado.<br>
                        <strong>Acesse através da rota:</strong><br>
                        <code style="background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 4px;">/whatsapp</code>
                    </div>
                `,setTimeout(()=>{const t=document.querySelector(".container"),o=document.createElement("button");o.textContent="Tentar Novamente",o.style.cssText=`
                        background: #4CAF50;
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 25px;
                        font-size: 1rem;
                        font-weight: 600;
                        cursor: pointer;
                        margin-top: 20px;
                        transition: background 0.3s;
                    `,o.onmouseover=()=>o.style.background="#45a049",o.onmouseout=()=>o.style.background="#4CAF50",o.onclick=()=>{const a=window.location.search;window.location.href=`/whatsapp${a}`},t.appendChild(o)},500);else{console.log("🔄 [REDIRECT] Tentando redirecionar para rota correta..."),window.reloadAttempted=!0;const o=`/whatsapp${window.location.search}`;document.querySelector(".loading-text").textContent="Redirecionando para rota correta...",setTimeout(()=>{window.location.href=o},1e3)}},3500)}),console.log("🎯 [REDIRECT] Script executado - DOM pronto:",document.readyState),console.log("🔍 [REDIRECT] window.zapLink no carregamento:",window.zapLink)}catch(g){console.error("❌ [REDIRECT] Erro no script redirect.js:",g),console.error("❌ [REDIRECT] Stack trace:",g.stack)}
