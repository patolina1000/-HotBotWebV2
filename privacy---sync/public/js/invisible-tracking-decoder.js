/**
 * üîê SISTEMA DE TRACKING INVIS√çVEL - DECODIFICADOR
 * Decodifica token JWT do tracking e dispara eventos invis√≠veis no checkout
 * Implementa√ß√£o totalmente invis√≠vel - nenhum dado sens√≠vel no client
 */

(function() {
  'use strict';

  const DEBUG_MODE = window.location.hostname === 'localhost' || 
                     window.location.hostname.includes('dev') || 
                     localStorage.getItem('invisible_debug') === 'true';

  function log(message, data = null) {
    if (DEBUG_MODE) {
      console.log(`[INVISIBLE-DECODER] ${message}`, data || '');
    }
  }

  class InvisibleTrackingDecoder {
    constructor() {
      this.trackingData = null;
      this.isInitialized = false;
      this.addToCartSent = false;
    }

    /**
     * üîì EXTRAIR TOKEN DA URL
     * Busca par√¢metro 'tt' (tracking token) na URL
     */
    extractTokenFromURL() {
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get('tt');
      
      if (token) {
        log('Token encontrado na URL');
        // Limpar token da URL para seguran√ßa
        this.cleanTokenFromURL();
        return token;
      }
      
      // Fallback: tentar sessionStorage
      const sessionToken = sessionStorage.getItem('invisible_tracking_token');
      if (sessionToken) {
        log('Token encontrado no sessionStorage');
        return sessionToken;
      }
      
      return null;
    }

    /**
     * üßπ LIMPAR TOKEN DA URL
     * Remove token da URL por seguran√ßa (sem reload)
     */
    cleanTokenFromURL() {
      const url = new URL(window.location);
      if (url.searchParams.has('tt')) {
        url.searchParams.delete('tt');
        window.history.replaceState({}, document.title, url.toString());
        log('Token removido da URL por seguran√ßa');
      }
    }

    /**
     * üîì DECODIFICAR TOKEN NO BACKEND
     * Envia token para backend e recebe dados decodificados
     */
    async decodeTrackingToken(token) {
      try {
        log('Decodificando token no backend...');

        const response = await fetch('/api/decode-tracking-token', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ token })
        });

        const result = await response.json();

        if (result.success) {
          log('Token decodificado com sucesso:', {
            has_fbp: !!result.data.fbp,
            has_fbc: !!result.data.fbc,
            utm_source: result.data.utm_source_name,
            utm_campaign: result.data.utm_campaign_name,
            external_id_hash: result.data.external_id_hash?.substring(0, 8) + '...'
          });

          this.trackingData = result.data;
          return { success: true, data: result.data };
        } else {
          console.warn('‚ö†Ô∏è Erro ao decodificar token:', result.error);
          return { success: false, error: result.error };
        }

      } catch (error) {
        console.error('‚ùå Erro na requisi√ß√£o de decodifica√ß√£o:', error);
        return { success: false, error: error.message };
      }
    }

    /**
     * üéØ DISPARAR ADDTOCART INVIS√çVEL
     * Envia evento AddToCart via backend (invis√≠vel)
     */
    async triggerInvisibleAddToCart(value = 19.90) {
      if (this.addToCartSent) {
        log('AddToCart j√° foi enviado - evitando duplica√ß√£o');
        return { success: true, duplicate: true };
      }

      if (!this.trackingData) {
        log('Nenhum dado de tracking dispon√≠vel para AddToCart');
        return { success: false, error: 'Sem dados de tracking' };
      }

      try {
        log('Disparando AddToCart invis√≠vel...', { value });

        // Gerar token tempor√°rio (apenas para esta sess√£o)
        const sessionToken = this.generateSessionToken();

        const response = await fetch('/api/invisible-addtocart', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            token: sessionToken,
            value: value
          })
        });

        const result = await response.json();

        if (result.success) {
          this.addToCartSent = true;
          log('AddToCart invis√≠vel enviado com sucesso:', {
            event_id: result.event_id
          });

          // Salvar no sessionStorage para evitar duplica√ß√£o
          sessionStorage.setItem('invisible_addtocart_sent', '1');
          sessionStorage.setItem('invisible_addtocart_event_id', result.event_id);

          return result;
        } else {
          console.error('‚ùå Erro ao enviar AddToCart invis√≠vel:', result.error);
          return result;
        }

      } catch (error) {
        console.error('‚ùå Erro na requisi√ß√£o AddToCart:', error);
        return { success: false, error: error.message };
      }
    }

    /**
     * üîë GERAR TOKEN DE SESS√ÉO
     * Cria token tempor√°rio com dados de tracking para backend
     */
    generateSessionToken() {
      if (!this.trackingData) return null;

      // Criar payload simples para sess√£o
      const sessionPayload = {
        external_id_hash: this.trackingData.external_id_hash,
        fbp: this.trackingData.fbp,
        fbc: this.trackingData.fbc,
        ip: this.trackingData.ip,
        user_agent: this.trackingData.user_agent,
        utm_source: this.trackingData.utm_source,
        utm_medium: this.trackingData.utm_medium,
        utm_campaign: this.trackingData.utm_campaign,
        utm_term: this.trackingData.utm_term,
        utm_content: this.trackingData.utm_content,
        session_id: Date.now()
      };

      // Codificar em base64 (n√£o √© criptografia, apenas encoding)
      return btoa(JSON.stringify(sessionPayload));
    }

    /**
     * üéØ CONFIGURAR EVENTOS AUTOM√ÅTICOS
     * Configura eventos que devem ser disparados automaticamente
     */
    setupAutomaticEvents() {
      // üî• CORRE√á√ÉO: ViewContent quando p√°gina carrega (2 segundos)
      setTimeout(() => {
        log('Disparando ViewContent ap√≥s 2 segundos do carregamento');
        // ViewContent √© disparado pelo Meta Pixel Bridge
        if (window.MetaPixelBridge) {
          window.MetaPixelBridge.fireViewContent();
        }
      }, 2000);

      // üî• CORRE√á√ÉO: AddToCart apenas quando PIX √© gerado, n√£o no carregamento
      // Interceptar formul√°rios de pagamento
      this.interceptPaymentForms();

      // Interceptar bot√µes de checkout
      this.interceptCheckoutButtons();
    }

    /**
     * üîó INTERCEPTAR FORMUL√ÅRIOS DE PAGAMENTO
     * Adiciona dados de tracking aos formul√°rios
     */
    interceptPaymentForms() {
      const forms = document.querySelectorAll('form[data-payment], form.payment-form, form#payment-form');
      
      forms.forEach(form => {
        form.addEventListener('submit', (event) => {
          if (this.trackingData) {
            // Adicionar campos hidden com dados de tracking
            this.addHiddenTrackingFields(form);
            log('Dados de tracking adicionados ao formul√°rio de pagamento');
          }
        });
      });

      log(`Intercepta√ß√£o configurada para ${forms.length} formul√°rios de pagamento`);
    }

    /**
     * üîó INTERCEPTAR BOT√ïES DE CHECKOUT
     * Configura eventos em bot√µes de finaliza√ß√£o
     */
    interceptCheckoutButtons() {
      const buttons = document.querySelectorAll(
        '.checkout-button, .payment-button, .buy-button, [data-checkout], button[type="submit"]'
      );
      
      buttons.forEach(button => {
        button.addEventListener('click', () => {
          // Disparar AddToCart se ainda n√£o foi enviado
          if (!this.addToCartSent && this.trackingData) {
            this.triggerInvisibleAddToCart();
          }
        });
      });

      log(`Intercepta√ß√£o configurada para ${buttons.length} bot√µes de checkout`);
    }

    /**
     * üîí ADICIONAR CAMPOS HIDDEN DE TRACKING
     * Adiciona campos ocultos com dados de tracking ao formul√°rio
     */
    addHiddenTrackingFields(form) {
      if (!this.trackingData) return;

      const trackingFields = {
        'tracking_external_id': this.trackingData.external_id_hash,
        'tracking_utm_source': this.trackingData.utm_source || '',
        'tracking_utm_campaign': this.trackingData.utm_campaign || '',
        'tracking_session_token': this.generateSessionToken()
      };

      Object.entries(trackingFields).forEach(([name, value]) => {
        // Remover campo existente se houver
        const existingField = form.querySelector(`input[name="${name}"]`);
        if (existingField) {
          existingField.remove();
        }

        // Adicionar novo campo
        const hiddenField = document.createElement('input');
        hiddenField.type = 'hidden';
        hiddenField.name = name;
        hiddenField.value = value;
        form.appendChild(hiddenField);
      });
    }

    /**
     * üöÄ INICIALIZAR SISTEMA
     * Configura decodificador quando p√°gina carrega
     */
    async initialize() {
      if (this.isInitialized) {
        log('Sistema j√° inicializado');
        return;
      }

      try {
        log('Inicializando decodificador de tracking invis√≠vel...');

        // Verificar se AddToCart j√° foi enviado
        if (sessionStorage.getItem('invisible_addtocart_sent')) {
          this.addToCartSent = true;
          log('AddToCart j√° foi enviado nesta sess√£o');
        }

        // Extrair token da URL
        const token = this.extractTokenFromURL();
        
        if (!token) {
          log('Nenhum token de tracking encontrado');
          this.isInitialized = true;
          return { success: false, reason: 'Sem token' };
        }

        // Decodificar token
        const decodeResult = await this.decodeTrackingToken(token);
        
        if (decodeResult.success) {
          // Configurar eventos autom√°ticos
          this.setupAutomaticEvents();
          
          this.isInitialized = true;
          log('Sistema de tracking invis√≠vel inicializado com sucesso');
          
          return { success: true, data: this.trackingData };
        } else {
          log('Falha ao decodificar token:', decodeResult.error);
          this.isInitialized = true;
          return decodeResult;
        }

      } catch (error) {
        console.error('‚ùå Erro ao inicializar decodificador:', error);
        this.isInitialized = true;
        return { success: false, error: error.message };
      }
    }

    /**
     * üîç UTILIT√ÅRIOS P√öBLICOS
     */
    hasTrackingData() {
      return !!this.trackingData;
    }

    getTrackingData() {
      return this.trackingData;
    }

    getExternalIdHash() {
      return this.trackingData?.external_id_hash || null;
    }
  }

  // Inst√¢ncia global
  window.InvisibleTracking = new InvisibleTrackingDecoder();

  /**
   * üîç UTILIT√ÅRIOS DE DEBUG
   */
  if (DEBUG_MODE) {
    window.InvisibleTrackingDebug = {
      ...window.InvisibleTrackingDebug,
      getDecodedData: () => window.InvisibleTracking.getTrackingData(),
      hasData: () => window.InvisibleTracking.hasTrackingData(),
      triggerAddToCart: (value) => window.InvisibleTracking.triggerInvisibleAddToCart(value),
      reinitialize: () => window.InvisibleTracking.initialize()
    };

    console.log('üîç Debug mode ativo. Use window.InvisibleTrackingDebug para utilit√°rios do decoder.');
  }

  /**
   * üé¨ INICIAR QUANDO DOM ESTIVER PRONTO
   */
  function initializeWhenReady() {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => window.InvisibleTracking.initialize(), 1000);
      });
    } else {
      // DOM j√° est√° pronto
      setTimeout(() => window.InvisibleTracking.initialize(), 1000);
    }
  }

  initializeWhenReady();

})();
