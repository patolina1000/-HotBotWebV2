<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Acesso Premium Verificado!</title>
  <style>
    body {
      background: #f0f4ff;
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      box-sizing: border-box;
    }
    .box {
      background: white;
      padding: 40px;
      border-radius: 15px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
      text-align: center;
      max-width: 450px;
      width: 100%;
    }
    h1 {
      color: #6366f1;
      margin-bottom: 20px;
    }
    p {
      margin: 15px 0;
      color: #333;
      line-height: 1.5;
    }
    .botao {
      display: inline-block;
      padding: 12px 24px;
      background-color: #6366f1;
      color: white;
      text-decoration: none;
      border-radius: 8px;
      margin-top: 20px;
      font-weight: bold;
      transition: background-color 0.3s;
    }
    .botao:hover {
      background-color: #4f46e5;
    }
    #erro {
      color: #e53e3e;
      font-weight: bold;
    }
    .hidden {
      display: none;
    }
    .checkmark {
      font-size: 48px;
      color: #6366f1;
      margin-bottom: 20px;
    }
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #6366f1;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .contador {
      color: #666;
      font-size: 14px;
      margin-top: 15px;
    }
    /* Estilos para dados do comprador */
    .dados-comprador {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    .dados-comprador h3 {
      margin: 0 0 15px 0;
      color: white;
      font-size: 18px;
    }
    .info-comprador {
      text-align: left;
      background: rgba(255, 255, 255, 0.1);
      padding: 15px;
      border-radius: 8px;
      backdrop-filter: blur(10px);
    }
    .info-comprador p {
      margin: 8px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .info-comprador strong {
      color: #e0e7ff;
    }
    .verificado {
      background: #10b981;
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
    }
  </style>
  <script src="utm-capture.js"></script>
  <script src="fbclid-handler.js"></script>
  <script src="event-id.js"></script>
  <script src="utmify-back-redirect.js"></script>
  <script
    src="https://cdn.utmify.com.br/scripts/utms/latest.js"
    data-utmify-prevent-xcod-sck
    data-utmify-prevent-subids
    async
    defer
  ></script>
</head>
<body>
  <div class="box">
    <h1>üéâ Acesso Premium Verificado!</h1>
    
    <div id="loading">
      <div class="spinner"></div>
      <p>Verificando seu pagamento e dados de verifica√ß√£o...</p>
    </div>

    <div id="conteudo" class="hidden">
      <div class="checkmark">‚úÖ</div>
      <p><strong>Acesso premium liberado com sucesso!</strong></p>
      
      <!-- Se√ß√£o de dados do comprador -->
      <div class="dados-comprador" id="dadosComprador" style="display: none;">
        <h3>üë§ Perfil Verificado</h3>
        <div class="info-comprador">
          <p><strong>Nome:</strong> <span id="nomeComprador">Carregando...</span></p>
          <p><strong>CPF:</strong> <span id="cpfComprador">Carregando...</span></p>
          <p><strong>Status:</strong> <span class="verificado" id="statusVerificacao">VERIFICADO ‚úì</span></p>
        </div>
      </div>
      
      <p>Seu acesso premium foi liberado com sucesso!</p>
      <p>Clique no bot√£o abaixo para acessar o canal VIP Premium quando desejar.</p>
      <a href="https://t.me/+0iLdVzcJsq9kOWQ5" class="botao" target="_blank">üöÄ Acessar Canal VIP Premium</a>
    </div>
    
    <div id="erro" class="hidden">
      <p>‚ùå <span id="erro-mensagem">Token inv√°lido ou j√° foi usado.</span></p>
      <p>Redirecionando para p√°gina inicial...</p>
    </div>
  </div>

  <!-- Facebook Pixel -->
  <script>
    window.fbConfig = { FB_PIXEL_ID: '', loaded: false };
    async function loadFacebookConfig() {
      try {
        const r = await fetch('/api/config');
        const cfg = await r.json();
        window.fbConfig.FB_PIXEL_ID = cfg.FB_PIXEL_ID;
        window.fbConfig.loaded = true;
      } catch (e) {
        console.error('Erro ao carregar config do Facebook', e);
      }
    }
    loadFacebookConfig();
  </script>
  <script>
    !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){
      n.callMethod ? n.callMethod.apply(n,arguments) : n.queue.push(arguments)};
      if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
      n.queue=[];t=b.createElement(e);t.async=!0;
      t.src=v;s=b.getElementsByTagName(e)[0];
      s.parentNode.insertBefore(t,s)
    }(window, document,'script','https://connect.facebook.net/en_US/fbevents.js');

    // Aguardar carregamento das configura√ß√µes antes de inicializar
    function initializeFacebookPixel() {
      if (window.fbConfig && window.fbConfig.loaded && window.fbConfig.FB_PIXEL_ID && typeof fbq === 'function') {
        // üî• DESABILITAR PUSHSTATE PARA EVITAR CONFLITOS
        fbq.disablePushState = true;
        
        fbq('init', window.fbConfig.FB_PIXEL_ID);
        
        const pageViewId = generateEventID('PageView');
        const pageViewData = { eventID: pageViewId };
        
        // Aguardar captura de UTMs antes de enviar PageView
        setTimeout(() => {
          const utmParams = captureUTMParams();
          if (utmParams.utm_source) {
            pageViewData.utm_source = utmParams.utm_source;
          }
          if (utmParams.utm_medium) {
            pageViewData.utm_medium = utmParams.utm_medium;
          }
          if (utmParams.utm_campaign) {
            pageViewData.utm_campaign = utmParams.utm_campaign;
          }
          if (utmParams.utm_term) {
            pageViewData.utm_term = utmParams.utm_term;
          }
          if (utmParams.utm_content) {
            pageViewData.utm_content = utmParams.utm_content;
          }
          
          fbq('track', 'PageView', pageViewData);
          console.log('Facebook Pixel PageView enviado:', pageViewData);
        }, 100);
      } else {
        setTimeout(initializeFacebookPixel, 100);
      }
    }
    
    initializeFacebookPixel();
  </script>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    const valor = urlParams.get('valor');
    let tokenValido = false;

    // Fun√ß√£o para buscar dados do comprador
    async function carregarDadosComprador(token) {
      try {
        const response = await fetch(`/api/dados-comprador?token=${token}`);
        const data = await response.json();
        
        if (data.success) {
          document.getElementById('nomeComprador').textContent = data.nome || 'N/A';
          document.getElementById('cpfComprador').textContent = data.cpf || 'N/A';
          document.getElementById('statusVerificacao').textContent = data.verificado ? 'VERIFICADO ‚úì' : 'PENDENTE';
          document.getElementById('dadosComprador').style.display = 'block';
        }
      } catch (error) {
        console.error('Erro ao carregar dados do comprador:', error);
        // N√£o exibir se√ß√£o se houver erro
      }
    }

    async function verificarToken() {
      if (!token) {
        mostrarErro('Token n√£o encontrado na URL.');
        return;
      }

      try {
        const response = await fetch(`/api/verificar-token?token=${token}`);
        const data = await response.json();

        if (data.sucesso) {
          tokenValido = true;
          
          // Marcar token como usado
          try {
            await fetch(`/api/marcar-usado?token=${token}`);
          } catch (error) {
            console.error('Erro ao marcar token como usado:', error);
          }
          
          // Carregar dados do comprador para bot especial
          await carregarDadosComprador(token);
          
          document.getElementById('loading').classList.add('hidden');
          document.getElementById('conteudo').classList.remove('hidden');
          
          // Enviar evento Purchase para Facebook
          await enviarEventoPurchase();
        } else {
          mostrarErro(data.erro || 'Token inv√°lido.');
        }
      } catch (error) {
        console.error('Erro ao verificar token:', error);
        mostrarErro('Erro ao verificar token. Tente novamente.');
      }
    }

    async function enviarEventoPurchase() {
      if (!tokenValido || !token) return;

      try {
        const purchaseEventId = generateEventID('Purchase');
        
        // Capturar UTMs da URL
        const utmParams = captureUTMParams();
        
        // Dados do evento Purchase
        const eventData = {
          token: token,
          valor: parseFloat(valor) || 0,
          event_id: purchaseEventId,
          utm_source: utmParams.utm_source,
          utm_medium: utmParams.utm_medium,
          utm_campaign: utmParams.utm_campaign,
          utm_term: utmParams.utm_term,
          utm_content: utmParams.utm_content,
          client_timestamp: Math.floor(Date.now() / 1000)
        };

        // Enviar para o servidor para processamento CAPI
        const response = await fetch('/api/facebook-purchase', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(eventData)
        });

        // Enviar Pixel (cliente)
        if (window.fbConfig && window.fbConfig.loaded && window.fbConfig.FB_PIXEL_ID && typeof fbq === 'function') {
          const pixelData = {
            value: parseFloat(valor) || 0,
            currency: 'BRL',
            eventID: purchaseEventId
          };

          // Adicionar UTMs se dispon√≠veis
          if (utmParams.utm_source) pixelData.utm_source = utmParams.utm_source;
          if (utmParams.utm_medium) pixelData.utm_medium = utmParams.utm_medium;
          if (utmParams.utm_campaign) pixelData.utm_campaign = utmParams.utm_campaign;
          if (utmParams.utm_term) pixelData.utm_term = utmParams.utm_term;
          if (utmParams.utm_content) pixelData.utm_content = utmParams.utm_content;

          fbq('track', 'Purchase', pixelData);
          console.log('Facebook Pixel Purchase enviado:', pixelData);
        }

      } catch (error) {
        console.error('Erro ao enviar evento Purchase:', error);
      }
    }

    function mostrarErro(mensagem) {
      document.getElementById('erro-mensagem').textContent = mensagem;
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('erro').classList.remove('hidden');
      
      setTimeout(() => {
        window.location.href = '/';
      }, 3000);
    }



    // Iniciar verifica√ß√£o
    verificarToken();
  </script>
</body>
</html>