<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Preparando acesso VIP‚Ä¶</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/telegram/styles.css" />

    <!-- [PIXEL] Comentado para evitar duplica√ß√£o; carregamento centralizado em ensureFacebookPixel.js -->
    <!--
    <noscript>
      <img
        height="1"
        width="1"
        style="display: none"
        src="https://www.facebook.com/tr?id=YOUR_PIXEL_ID&ev=PageView&noscript=1"
        alt=""
      />
    </noscript>
    <script>
      (function (window, document) {
        if (window.__fbPixelConfigPromise) {
          return;
        }

        window.__FB_PIXEL_ID__ = window.__FB_PIXEL_ID__ || null;
        window.__FB_PIXEL_TOKEN__ = window.__FB_PIXEL_TOKEN__ || null;

        let isResolved = false;
        let resolvePromiseCallback = () => {};
        const resolveOnce = (value) => {
          if (isResolved) {
            return;
          }

          isResolved = true;
          resolvePromiseCallback(value);
        };

        const loadConfig = () => {
          if (typeof fetch !== 'function') {
            console.warn('Fetch API indispon√≠vel: configura√ß√£o do Meta Pixel n√£o carregada.');
            resolveOnce(null);
            return;
          }

          fetch('/api/config', { credentials: 'same-origin' })
            .then((response) => (response.ok ? response.json() : null))
            .then((config) => {
              if (config && config.FB_PIXEL_ID) {
                try {
                  const initOptions = { autoConfig: false };
                  fbq('init', config.FB_PIXEL_ID, {}, initOptions);
                  window.__FB_PIXEL_ID__ = config.FB_PIXEL_ID;

                  if (config.FB_PIXEL_TOKEN) {
                    window.__FB_PIXEL_TOKEN__ = config.FB_PIXEL_TOKEN;
                  }

                  resolveOnce(config);
                  return;
                } catch (error) {
                  console.warn('N√£o foi poss√≠vel inicializar o Meta Pixel.', error);
                  resolveOnce(null);
                  return;
                }
              }

              console.warn('Meta Pixel ID n√£o configurado no servidor.');
              resolveOnce(config);
            })
            .catch((error) => {
              console.warn('N√£o foi poss√≠vel carregar a configura√ß√£o do Meta Pixel.', error);
              resolveOnce(null);
            });
        };

        window.__fbPixelConfigPromise = new Promise((resolve) => {
          resolvePromiseCallback = resolve;

          const initialize = () => {
            try {
              loadConfig();
            } catch (error) {
              console.warn('Erro inesperado ao configurar o Meta Pixel.', error);
              resolveOnce(null);
            }
          };

          if (window.fbq && typeof window.fbq === 'function') {
            initialize();
            return;
          }

          const existingPixelScript = document.querySelector(
            'script[src*="connect.facebook.net/en_US/fbevents.js"]'
          );

          if (existingPixelScript) {
            if (existingPixelScript.hasAttribute('data-pixel-loader-initialized')) {
              existingPixelScript.addEventListener('load', initialize, { once: true });
            } else {
              existingPixelScript.setAttribute('data-pixel-loader-initialized', 'true');
              existingPixelScript.addEventListener('load', initialize, { once: true });
              existingPixelScript.addEventListener('error', (error) => {
                console.warn('N√£o foi poss√≠vel carregar o script do Meta Pixel.', error);
                resolveOnce(null);
              }, { once: true });
            }
            return;
          }

          !(function (f, b, e, v, n, t, s) {
            if (f.fbq) {
              initialize();
              return;
            }
            n = f.fbq = function () {
              n.callMethod ? n.callMethod.apply(n, arguments) : n.queue.push(arguments);
            };
            if (!f._fbq) f._fbq = n;
            n.push = n;
            n.loaded = !0;
            n.version = '2.0';
            n.queue = [];
            t = b.createElement(e);
            t.async = !0;
            t.src = v;
            t.setAttribute('data-pixel-loader-initialized', 'true');
            t.onload = initialize;
            t.onerror = function (error) {
              console.warn('N√£o foi poss√≠vel carregar o script do Meta Pixel.', error);
              resolveOnce(null);
            };
            s = b.getElementsByTagName(e)[0];
            s.parentNode.insertBefore(t, s);
          })(window, document, 'script', 'https://connect.facebook.net/en_US/fbevents.js');
        });
      })(window, document);
    </script>
    -->
    <!-- End Meta Pixel Code -->
    
    <!-- ‚úÖ CARREGAMENTO CENTRALIZADO DO META PIXEL -->
    <script src="/js/ensureFacebookPixel.js"></script>
    <script>
      // Carregar Pixel ID do backend e inicializar uma √∫nica vez
      fetch('/api/config', { credentials: 'same-origin' })
        .then((response) => (response.ok ? response.json() : null))
        .then((config) => {
          if (config && config.FB_PIXEL_ID) {
            window.ENV = window.ENV || {};
            window.ENV.FB_PIXEL_ID = config.FB_PIXEL_ID;
            
            window.__FB_PIXEL_ID__ = config.FB_PIXEL_ID;
            if (config.FB_PIXEL_TOKEN) {
              window.__FB_PIXEL_TOKEN__ = config.FB_PIXEL_TOKEN;
            }
            
            // Inicializar pixel centralizado
            ensureFacebookPixel(config.FB_PIXEL_ID, window.__USER_DATA || null);
          } else {
            console.warn('[PIXEL] ‚ö†Ô∏è Meta Pixel ID n√£o configurado no servidor.');
          }
        })
        .catch((error) => {
          console.warn('[PIXEL] ‚ùå N√£o foi poss√≠vel carregar a configura√ß√£o do Meta Pixel.', error);
        });
    </script>
    
    <!-- üîç SANITY CHECK: Verificar scripts fbevents.js carregados -->
    <script>
      (function () {
        setTimeout(function() {
          const list = [...document.querySelectorAll('script[src*="fbevents.js"]')].map(s=>s.src);
          console.log('[PIXEL] fbevents scripts:', list);
          if (list.length > 1) {
            console.warn('[PIXEL] ‚ö†Ô∏è Conflito: m√∫ltiplos fbevents.js detectados', list);
          } else if (list.length === 1) {
            console.log('[PIXEL] ‚úÖ Apenas 1 fbevents.js carregado (correto)');
          }
        }, 1000);
      })();
    </script>
  </head>
  <body>
    <div class="page-wrapper">
      <article class="vip-card" aria-live="polite">
        <header class="header">
          <img
            src="../assets/icon-2.png"
            alt="Telegram"
            class="telegram-logo"
          />
          <img
            src="../assets/imagem.jpg"
            alt="Avatar"
            class="avatar"
          />
        </header>

        <div class="status-line" aria-live="polite">
          <span class="status-dot" aria-hidden="true"></span>
          <span class="status-text">ONLINE AGORA</span>
          <span class="status-separator">¬∑</span>
          <span class="status-location">
            <img
              src="../assets/157354.svg"
              alt=""
              class="status-location-icon"
              aria-hidden="true"
            />
            <span id="city" class="status-city">Detectando...</span>
          </span>
        </div>

        <h1 class="title">
          Estamos preparando seu <span>acesso VIP‚Ä¶</span>
        </h1>

        <p class="subtitle">
          Aguarde alguns segundos enquanto configuramos seu acesso exclusivo.
        </p>

        <div class="info">
          <span>üî• 92% das vagas j√° foram</span>
          <span>preenchidas</span>
        </div>

        <div class="progress" aria-hidden="true">
          <div class="bar" id="progress-bar"></div>
        </div>

        <p id="countdown" class="countdown">Redirecionando em 4 segundos...</p>
      </article>
    </div>

    <script>
      window.BOT1_LINK_FROM_SERVER = "__BOT1_TELEGRAM_LINK__";
    </script>
    <script src="/telegram/fbclid-handler.js" defer></script>
    <script src="/telegram/utmify.js" defer></script>
    <script src="/telegram/utmify-pixel-interceptor.js" defer></script>
    <script src="/telegram/geolocation.js" defer></script>
    <script src="/telegram/app.js" defer></script>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const infoElement = document.querySelector('.info');
        if (!infoElement) return;

        const lines = infoElement.querySelectorAll('span');
        if (lines.length < 2) return;

        const messages = [
          ['üî• 92% das vagas j√° foram', 'preenchidas'],
          ['‚úÖ 3.948 pessoas acessaram', 'nas √∫ltimas 24h'],
          ['üî• Restam apenas 37 acessos', 'gratuitos']
        ];

        let currentIndex = 0;
        const fadeDuration = 320;

        const applyMessage = (index) => {
          const [lineOne, lineTwo] = messages[index];
          lines[0].textContent = lineOne;
          lines[1].textContent = lineTwo;
        };

        const getStableDelay = () => 2000;

        const scheduleSingleChange = (delay) => {
          window.setTimeout(() => {
            infoElement.classList.add('is-fading');

            window.setTimeout(() => {
              currentIndex = (currentIndex + 1) % messages.length;
              applyMessage(currentIndex);

              window.requestAnimationFrame(() => {
                infoElement.classList.remove('is-fading');
              });
            }, fadeDuration);
          }, delay);
        };

        applyMessage(currentIndex);
        scheduleSingleChange(getStableDelay());
      });
    </script>
  </body>
</html>
