<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta name="facebook-domain-verification" content="62pz7fns7akzu7khx80kk0uth0fq99" />
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title id="dynamic-title">Carregando...</title>
  <meta name="robots" content="noindex, nofollow" />

  <!-- Facebook Pixel -->
  <script>
    !function(f,b,e,v,n,t,s){
      if(f.fbq)return;n=f.fbq=function(){
        n.callMethod ? n.callMethod.apply(n,arguments) : n.queue.push(arguments)};
      if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
      n.queue=[];t=b.createElement(e);t.async=!0;
      t.src=v;s=b.getElementsByTagName(e)[0];
      s.parentNode.insertBefore(t,s)
    }(window, document, 'script', 'https://connect.facebook.net/en_US/fbevents.js');

    fbq('init', '1429424624747459');
    fbq('track', 'PageView');
  </script>

  <link rel="stylesheet" href="style.css" />
  <script src="config.js"></script>
  <script src="utm-capture.js"></script>
  <script src="lz-string.min.js"></script>
</head>
<body>
  <div class="overlay">
    <video id="promo-video" src="assets/video.mp4" autoplay muted loop playsinline></video>
    <h1 id="headline">Tem uma parte minha que você ainda não viu...</h1>
    <p id="description">Eu gravei tudo. Acompanhada.<br />Entrega real, gemido real... e só pra quem tem coragem de ir até o fim.</p>
    <a id="cta" class="btn btn-pastel" href="#">Quero ver agora, sem censura</a>
  </div>

  <script>
    // Aplica conteúdo da config
    document.title = window.config.title;
    document.getElementById("headline").innerText = window.config.headline;
    document.getElementById("description").innerText = window.config.description;

    const cta = document.getElementById("cta");
    cta.innerText = window.config.buttonText;

    // Monta link de redirecionamento mantendo possíveis parâmetros UTM
    const baseUrl = 'https://t.me/vipshadrie_bot';
    const urlParams = new URLSearchParams(window.location.search);
    ['utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 'utm_content']
      .forEach(key => {
        const stored = localStorage.getItem(key);
        const value = urlParams.get(key) || stored;
        if (value) urlParams.set(key, value);
      });

    // Armazena dados de rastreamento que serão enviados ao Telegram
    const trackData = {};

    // Captura _fbp, _fbc, IP e User-Agent se ainda não estiverem no localStorage
    (function() {
      function getCookie(name) {
        const m = document.cookie.match(new RegExp('(?:^|; )' + name + '=([^;]*)'));
        return m ? decodeURIComponent(m[1]) : null;
      }

      function storePixelCookies() {
        try {
          if (!localStorage.getItem('fbp')) {
            if (typeof fbq === 'function') {
              fbq('get', 'fbp', val => { if (val) localStorage.setItem('fbp', val); });
            } else {
              const fbp = getCookie('_fbp');
              if (fbp) localStorage.setItem('fbp', fbp);
            }
          }
          if (!localStorage.getItem('fbc')) {
            if (typeof fbq === 'function') {
              fbq('get', 'fbc', val => { if (val) localStorage.setItem('fbc', val); });
            } else {
              const fbc = getCookie('_fbc');
              if (fbc) localStorage.setItem('fbc', fbc);
            }
          }
        } catch (e) {}

        const fbp = localStorage.getItem('fbp');
        if (fbp) trackData.fbp = fbp; else delete trackData.fbp;
        const fbc = localStorage.getItem('fbc');
        if (fbc) trackData.fbc = fbc; else delete trackData.fbc;
        rebuildParams();
        let newUtm = urlParams.toString();
        if (newUtm.length > 64) {
          delete trackData.ip; rebuildParams();
          newUtm = urlParams.toString();
        }
        if (newUtm.length > 64) {
          delete trackData.fbc; rebuildParams();
          newUtm = urlParams.toString();
        }
        if (newUtm.length > 64) {
          urlParams.delete('p');
          newUtm = urlParams.toString();
        }
        cta.href = newUtm ? `${baseUrl}?start=${newUtm}` : baseUrl;
      }

      storePixelCookies();
      setTimeout(storePixelCookies, 500);

      if (!localStorage.getItem('client_ip_address')) {
        fetch('https://api.ipify.org?format=json').then(r => r.json()).then(d => {
          if (d && d.ip) localStorage.setItem('client_ip_address', d.ip);
        }).catch(() => {});
      }
      if (!localStorage.getItem('user_agent_criacao')) {
        try {
          localStorage.setItem('user_agent_criacao', navigator.userAgent);
        } catch (e) {}
      }
    })();

    // Constrói payload resumido e compactado para o Telegram
    const fbpPayload = localStorage.getItem('fbp');
    if (fbpPayload) trackData.fbp = fbpPayload;
    const fbcPayload = localStorage.getItem('fbc');
    if (fbcPayload) trackData.fbc = fbcPayload;
    const ipPayload = localStorage.getItem('client_ip_address');
    if (ipPayload) trackData.ip = ipPayload;

    function rebuildParams() {
      if (Object.keys(trackData).length) {
        urlParams.set('p', LZString.compressToEncodedURIComponent(JSON.stringify(trackData)));
      } else {
        urlParams.delete('p');
      }
    }

    rebuildParams();
    let utmString = urlParams.toString();
    if (utmString.length > 64) {
      delete trackData.ip; rebuildParams();
      utmString = urlParams.toString();
    }
    if (utmString.length > 64) {
      delete trackData.fbc; rebuildParams();
      utmString = urlParams.toString();
    }
    if (utmString.length > 64) {
      urlParams.delete('p');
      utmString = urlParams.toString();
    }
    cta.href = utmString ? `${baseUrl}?start=${utmString}` : baseUrl;

    // Evento de clique com redirecionamento direto
    cta.addEventListener("click", function () {
      try {
        fbq('track', 'ViewContent', {
          content_name: window.config.headline,
          content_category: 'Bot Telegram'
        });
      } catch (e) {
        console.error('Facebook Pixel error', e);
      }
    });

    // Aplica imagem de fundo
    document.body.style.backgroundImage = `url('${window.config.backgroundImage}')`;
  </script>
</body></html>
