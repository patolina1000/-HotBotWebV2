<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta name="facebook-domain-verification" content="62pz7fns7akzu7khx80kk0uth0fq99" />
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title id="dynamic-title">Carregando...</title>
  <meta name="robots" content="noindex, nofollow" />

  <!-- Facebook Pixel -->
  <script>
    !function(f,b,e,v,n,t,s){
      if(f.fbq)return;n=f.fbq=function(){
        n.callMethod ? n.callMethod.apply(n,arguments) : n.queue.push(arguments)};
      if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
      n.queue=[];t=b.createElement(e);t.async=!0;
      t.src=v;s=b.getElementsByTagName(e)[0];
      s.parentNode.insertBefore(t,s)
    }(window, document, 'script', 'https://connect.facebook.net/en_US/fbevents.js');

    fbq('init', '1429424624747459');
    fbq('track', 'PageView');
  </script>

  <link rel="stylesheet" href="style.css" />
  <script src="config.js"></script>
  <script src="utm-capture.js"></script>
  <script src="lz-string.min.js"></script>
</head>
<body>
  <div class="overlay">
    <video id="promo-video" src="assets/video.mp4" autoplay muted loop playsinline></video>
    <h1 id="headline">Tem uma parte minha que você ainda não viu...</h1>
    <p id="description">Eu gravei tudo. Acompanhada.<br />Entrega real, gemido real... e só pra quem tem coragem de ir até o fim.</p>
    <a id="cta" class="btn btn-pastel" href="#">Quero ver agora, sem censura</a>
  </div>

  <script>
  const cta = document.getElementById("cta");
  const baseUrl = "https://t.me/vipshadrie_bot";
  const trackData = {};
  const PIXEL_ID = '1429424624747459';

  function getCookie(name) {
    const match = document.cookie.match(new RegExp('(?:^|; )' + name + '=([^;]*)'));
    return match ? decodeURIComponent(match[1]) : null;
  }

  function getPixelValue(lsKey, cookieName) {
    const defaultValue = lsKey === 'fbp' ? 'nofbp' : 'nofbc';
    return new Promise(resolve => {
      try {
        const stored = localStorage.getItem(lsKey);
        if (stored) return resolve(stored);

        const cookieVal = getCookie(cookieName);
        if (cookieVal) {
          localStorage.setItem(lsKey, cookieVal);
          return resolve(cookieVal);
        }
      } catch (e) {
        console.error('Erro ao acessar storage/cookie', e);
      }

      resolve(defaultValue);
    });
  }

  async function gatherTracking() {
    const fresh = {};

    const [fbp, fbc] = await Promise.all([
      getPixelValue('fbp', '_fbp'),
      getPixelValue('fbc', '_fbc')
    ]);

    let ip = localStorage.getItem('client_ip_address');
    if (!ip) {
      try {
        const fetchIp = fetch('https://api.ipify.org?format=json').then(r => r.json()).then(d => d.ip);
        ip = await Promise.race([
          fetchIp,
          new Promise(res => setTimeout(() => res(null), 2000))
        ]);
        if (ip) localStorage.setItem('client_ip_address', ip);
      } catch (e) {}
    }

    let ua = localStorage.getItem('user_agent_criacao');
    if (!ua) {
      try {
        ua = navigator.userAgent;
        localStorage.setItem('user_agent_criacao', ua);
      } catch (e) {}
    }

    const urlParams = new URLSearchParams(window.location.search);
    ['utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 'utm_content'].forEach(key => {
      const value = urlParams.get(key) || localStorage.getItem(key);
      if (value) {
        fresh[key] = value;
        localStorage.setItem(key, value);
      }
    });

    if (fbp) fresh.fbp = fbp;
    if (fbc) fresh.fbc = fbc;
    if (ip) fresh.ip = ip;
    if (ua) fresh.user_agent = ua;

    Object.assign(trackData, fresh);
    console.log('[DEBUG] trackData:', trackData);
    return fresh;
  }


  async function prepareLink() {
    try {
      await gatherTracking();

      const strategies = [
        () => ({ ...trackData }),
        () => {
          const { ip, user_agent, utm_content, ...rest } = trackData;
          return rest;
        },
        () => {
          const { utm_source, utm_medium, utm_campaign, fbp, fbc } = trackData;
          return { utm_source, utm_medium, utm_campaign, fbp, fbc };
        },
        () => {
          const { fbp, fbc, utm_source } = trackData;
          return { fbp, fbc, utm_source };
        },
        () => {
          const { fbp, fbc } = trackData;
          return { fbp, fbc };
        },
        () => {
          const { fbp } = trackData;
          return { fbp };
        },
        () => ({ fbp: 'nofbp' })
      ];

      let finalData = {};
      let compressed = '';
      let strategyUsed = 0;

      for (let i = 0; i < strategies.length; i++) {
        const testData = strategies[i]();
        if (!Object.keys(testData).length) continue;

        const testCompressed = LZString.compressToEncodedURIComponent(JSON.stringify(testData));

        if (testCompressed && testCompressed.length <= 64) {
          finalData = testData;
          compressed = testCompressed;
          strategyUsed = i + 1;
          break;
        }
      }

      const finalLink = compressed ? `${baseUrl}?start=${compressed}` : baseUrl;
      cta.href = finalLink;

      const strategyNames = [
        'Completa',
        'Sem dados técnicos',
        'UTMs + Pixels',
        'Pixels + Source',
        'Apenas Pixels',
        'Apenas FBP',
        'Mínima'
      ];

      console.log('[DEBUG] Estratégia usada:', strategyNames[strategyUsed - 1] || 'Nenhuma');
      console.log('[DEBUG] Dados incluídos:', Object.keys(finalData).join(', ') || 'nenhum');
      console.log('[DEBUG] Dados omitidos:', Object.keys(trackData).filter(k => !finalData[k]).join(', ') || 'nenhum');
      console.log('[DEBUG] Tamanho final:', compressed.length);
      console.log('[DEBUG] Dentro do limite (≤64):', compressed.length <= 64);
      console.log('[DEBUG] URL final:', finalLink);

    } catch (e) {
      console.error('Erro ao preparar link', e);
      cta.href = baseUrl;
    }
  }

  window.addEventListener('load', async () => {
    cta.classList.add('disabled');
    cta.href = '#';

    await prepareLink();
    cta.classList.remove('disabled');
  });

  cta.addEventListener("click", function () {
    try {
      fbq('track', 'ViewContent', {
        content_name: window.config.headline,
        content_category: 'Bot Telegram'
      });
    } catch (e) {
      console.error('Facebook Pixel error', e);
    }
  });

  // Função auxiliar para testar estratégias manualmente
  function testAllStrategies() {
    console.log('=== TESTE DE ESTRATÉGIAS ===');

    const strategies = [
      { name: 'Completa', data: { ...trackData } },
      { name: 'Sem técnicos', data: (({ ip, user_agent, utm_content, ...rest }) => rest)(trackData) },
      { name: 'UTMs + Pixels', data: (({ utm_source, utm_medium, utm_campaign, fbp, fbc }) => ({ utm_source, utm_medium, utm_campaign, fbp, fbc }))(trackData) },
      { name: 'Pixels + Source', data: (({ fbp, fbc, utm_source }) => ({ fbp, fbc, utm_source }))(trackData) },
      { name: 'Apenas Pixels', data: (({ fbp, fbc }) => ({ fbp, fbc }))(trackData) },
      { name: 'Apenas FBP', data: (({ fbp }) => ({ fbp }))(trackData) }
    ];

    strategies.forEach((strategy, i) => {
      const compressed = LZString.compressToEncodedURIComponent(JSON.stringify(strategy.data));
      const withinLimit = compressed.length <= 64;
      console.log(`${i + 1}. ${strategy.name}: ${compressed.length} chars ${withinLimit ? '✅' : '❌'}`);
    });
  }

  document.body.style.backgroundImage = `url('${window.config.backgroundImage}')`;
  </script>
</body></html>
