<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title id="dynamic-title">Carregando...</title>
  <meta name="robots" content="noindex, nofollow" />

  <!-- Facebook Pixel -->
  <script src="fb-config.js"></script>
  <script>
    !function(f,b,e,v,n,t,s){
      if(f.fbq)return;n=f.fbq=function(){
        n.callMethod ? n.callMethod.apply(n,arguments) : n.queue.push(arguments)};
      if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
      n.queue=[];t=b.createElement(e);t.async=!0;
      t.src=v;s=b.getElementsByTagName(e)[0];
      s.parentNode.insertBefore(t,s)
    }(window, document, 'script', 'https://connect.facebook.net/en_US/fbevents.js');

    // Aguardar carregamento das configura√ß√µes antes de inicializar
    function initializeFacebookPixel() {
      if (window.fbConfig && window.fbConfig.loaded && window.fbConfig.FB_PIXEL_ID) {
        fbq('init', window.fbConfig.FB_PIXEL_ID);
        
        const pageViewId = generateEventID('PageView');
        const pageViewData = { eventID: pageViewId };
        if (window.fbConfig.FB_TEST_EVENT_CODE) {
          pageViewData.test_event_code = window.fbConfig.FB_TEST_EVENT_CODE;
        }
        fbq('track', 'PageView', pageViewData);
        
        const viewInitId = generateEventID('ViewContent');
        const viewContentData = {
          value: parseFloat((Math.random() * (19.90 - 9.90) + 9.90).toFixed(2)),
          currency: 'BRL',
          eventID: viewInitId
        };
        if (window.fbConfig.FB_TEST_EVENT_CODE) {
          viewContentData.test_event_code = window.fbConfig.FB_TEST_EVENT_CODE;
        }
        fbq('track', 'ViewContent', viewContentData);
        
        console.debug('üîß Facebook Pixel inicializado com:', window.fbConfig.FB_PIXEL_ID);
      } else {
        // Retry ap√≥s 100ms se configura√ß√µes ainda n√£o carregaram
        setTimeout(initializeFacebookPixel, 100);
      }
    }
    
    // Inicializar quando DOM estiver pronto
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeFacebookPixel);
    } else {
      initializeFacebookPixel();
    }
  </script>

  <link rel="stylesheet" href="style.css" />
  <script src="config.js"></script>
  <script src="utm-capture.js"></script>
  <script src="event-id.js"></script>
</head>
<body>
  <div class="overlay">
    <div id="message">
        <p>Antes que feche esse quartinho...</p>
      <p>Tem umas coisinhas bem √≠ntimas te esperando... Vai entrar ou vai ficar babando do lado de fora?</p>
    </div>
    <a id="cta" class="btn btn-pastel" href="#">Carregando bot√£o...</a>
  </div>

  <script>
    // Aplica conte√∫do da config
    document.title = window.config.title;
    // texto fixo definido no HTML

    const cta = document.getElementById("cta");
    cta.innerText = window.config.buttonText;

    // Base do bot
    const baseUrl = window.config.redirectLink;

    // Garante que UTMs da URL continuem salvos
    const urlParams = new URLSearchParams(window.location.search);
    ['utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 'utm_content']
      .forEach(key => {
        const value = urlParams.get(key) || localStorage.getItem(key);
        if (value) localStorage.setItem(key, value);
      });

    const trackData = {};

    function gatherTracking() {
      const fresh = {};
      const fbp = getPixelVal('fbp', '_fbp');
      const fbc = getPixelVal('fbc', '_fbc');
      const user_agent = navigator.userAgent || '';

      ['utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 'utm_content']
        .forEach(key => {
          const value = localStorage.getItem(key);
          if (value) fresh[key] = value;
        });

      if (fbp) fresh.fbp = fbp;
      if (fbc) fresh.fbc = fbc;
      if (user_agent) fresh.user_agent = user_agent;

      Object.assign(trackData, fresh);
      return fresh;
    }

    function getCookie(name) {
      const match = document.cookie.match(new RegExp('(?:^|; )' + name + '=([^;]*)'));
      return match ? decodeURIComponent(match[1]) : null;
    }

    function getPixelVal(lsKey, cookieName) {
      try {
        const stored = localStorage.getItem(lsKey);
        if (stored) return stored;
        const cookieVal = getCookie(cookieName);
        if (cookieVal) {
          localStorage.setItem(lsKey, cookieVal);
          return cookieVal;
        }
      } catch (e) {
        console.error('Erro ao acessar storage/cookie', e);
      }
      return null;
    }

    async function gerarPayload() {
      // Captura cookies do Facebook mais recentes antes de gerar payload
      gatherTracking();
      
      // Garantir que temos os cookies mais recentes usando a fun√ß√£o do utm-capture.js
      if (window.getFacebookCookies) {
        const freshCookies = window.getFacebookCookies();
        if (freshCookies.fbp) trackData.fbp = freshCookies.fbp;
        if (freshCookies.fbc) trackData.fbc = freshCookies.fbc;
      }
      
      const { fbp, fbc, user_agent, utm_source, utm_medium, utm_campaign, utm_term, utm_content } = trackData;

      try {
        const resp = await fetch('/api/gerar-payload', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            fbp,
            fbc,
            user_agent,
            utm_source,
            utm_medium,
            utm_campaign,
            utm_term,
            utm_content
          })
        });

        const data = await resp.json().catch(() => ({}));
        if (resp.ok && data.payload_id) {
          cta.href = `${baseUrl}?start=${data.payload_id}`;
          console.log('üîó Payload gerado com cookies do Facebook:', { fbp: !!fbp, fbc: !!fbc });
        } else {
          cta.href = baseUrl;
        }
      } catch (e) {
        console.error('Erro ao gerar payload', e);
        cta.href = baseUrl;
      }
    }

    // Evento de clique com redirecionamento direto
    cta.addEventListener("click", function () {
      const viewContentData = {
        value: parseFloat((Math.random() * (19.90 - 9.90) + 9.90).toFixed(2)),
        currency: 'BRL',
        content_name: window.config.headline,
        content_category: 'Bot Telegram',
        eventID: generateEventID('ViewContent')
      };
      if (window.fbConfig && window.fbConfig.FB_TEST_EVENT_CODE) {
        viewContentData.test_event_code = window.fbConfig.FB_TEST_EVENT_CODE;
      }
      fbq('track', 'ViewContent', viewContentData);
    });

    // Aplica imagem de fundo
    document.body.style.backgroundImage = `url('${window.config.backgroundImage}')`;

    // Atualiza link final com payload gerado somente ap√≥s o carregamento
    window.addEventListener('load', () => {
      setTimeout(gerarPayload, 500);
    });
  </script>

</body>
</html>
