â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ¯ PATCH: EliminaÃ§Ã£o do Warning Meta Pixel - Invalid Parameter "pixel_id"
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ RESUMO
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Este patch elimina o warning:
  [Meta Pixel] - Call to "fbq('set', 'userData', Object);" with parameter 
  "pixel_id" has an invalid value of "'1280205146659070'"

âš ï¸ CAUSA: Aspas residuais no Pixel ID do .env + redundÃ¢ncia do set('userData')
           em ambiente single pixel.

âœ… SOLUÃ‡ÃƒO: 
   1. SanitizaÃ§Ã£o de Pixel ID (remoÃ§Ã£o de aspas)
   2. SanitizaÃ§Ã£o de userData (remoÃ§Ã£o de chaves proibidas)
   3. CondicionalizaÃ§Ã£o do fbq('set','userData') em single pixel
   4. Logs de diagnÃ³stico [AM-FIX]

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“¦ ARQUIVOS MODIFICADOS/CRIADOS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

NOVO:
  âœ… public/js/fbPixelUtils.js (113 linhas)
     - sanitizePixelId()
     - sanitizeUserData()
     - sanitizeFbqSetUserDataArgs()

MODIFICADOS:
  âœ… public/js/ensureFacebookPixel.js
     - Sanitiza pixelId antes de usar
     - Passa userData via init quando disponÃ­vel
     - Define window.__fbUserDataSetViaInit

  âœ… MODELO1/WEB/obrigado_purchase_flow.html
     - Carrega fbPixelUtils.js
     - ReforÃ§a guard com case-insensitive
     - Condicionaliza fbq('set','userData')
     - Adiciona fallback inteligente

  âœ… public/js/pixelValidation.js
     - CHECK 8: Single Pixel validation
     - CHECK 9: fbPixelUtils availability

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸš€ COMO APLICAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

OPÃ‡ÃƒO 1: Aplicar patch completo
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  git apply meta-pixel-complete.patch

OPÃ‡ÃƒO 2: Aplicar manualmente
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  1. Criar: public/js/fbPixelUtils.js (veja o conteÃºdo no patch)
  2. Modificar: public/js/ensureFacebookPixel.js
  3. Modificar: MODELO1/WEB/obrigado_purchase_flow.html
  4. Modificar: public/js/pixelValidation.js

OPÃ‡ÃƒO 3: Revisar e aplicar mudanÃ§as individuais
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Veja o diff completo em: meta-pixel-complete.patch
  Leia a documentaÃ§Ã£o em: META_PIXEL_FIX_PATCH.md

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… VALIDAÃ‡ÃƒO PÃ“S-APLICAÃ‡ÃƒO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

LOGS ESPERADOS no console:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  [AM-FIX] fbPixelUtils.js carregado
  [AM-FIX] ensureFacebookPixel | pixelId sanitized | before= ... after= ...
  [AM-FIX] init userData source=init | keys= [...] | removedPixelKeys= false
  [PIXEL] âœ… init 1280205146659070 (v=2.0) | userData=init
  [AM-FIX] skip set userData | viaInit= true | viaSet= false
  [ADVANCED-MATCH-FRONT] set userData before Purchase | ok=true | viaInit=true
  [PURCHASE-BROWSER] âœ… Purchase enviado ao Pixel (plaintext AM)

WARNING QUE DEVE DESAPARECER:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  âŒ [Meta Pixel] - Call to "fbq('set', 'userData', Object);" with parameter 
     "pixel_id" has an invalid value of "'1280205146659070'"

TESTES NECESSÃRIOS:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  1. âœ… Warning desapareceu do console
  2. âœ… Purchase (browser) enviado normalmente
  3. âœ… Purchase (CAPI) recebido no backend
  4. âœ… Event Manager mostra 1 Purchase (deduplicaÃ§Ã£o OK)
  5. âœ… userData presente (em, ph, fn, ln, external_id, fbp, fbc)
  6. âœ… Logs [AM-FIX] presentes
  7. âœ… pixelValidation mostra isSinglePixel=true

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“Š ESTATÃSTICAS DO PATCH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  Total de linhas modificadas: ~354 linhas
  
  Arquivos criados: 1
    - public/js/fbPixelUtils.js
  
  Arquivos modificados: 3
    - MODELO1/WEB/obrigado_purchase_flow.html
    - public/js/ensureFacebookPixel.js
    - public/js/pixelValidation.js
  
  CÃ³digo comentado (nÃ£o removido): 1 linha
    - fbq('set', 'userData', userDataPlain); // Agora comentado
  
  Logs adicionados:
    - [AM-FIX] sanitizePixelId | before=... after=...
    - [AM-FIX] sanitizeUserData | removedPixelKeys=[...]
    - [AM-FIX] ensureFacebookPixel | pixelId sanitized
    - [AM-FIX] init userData source=init | keys=...
    - [AM-FIX] set userData fallback | keys=...
    - [AM-FIX] skip set userData | viaInit=... viaSet=...
    - [AM-FIX] pixelValidation | sdkLoadedOnce=... isSinglePixel=...
    - [FBQ GUARD] chaves removidas: [...]

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“ SUPORTE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Em caso de dÃºvidas:
  1. Consulte: META_PIXEL_FIX_PATCH.md (documentaÃ§Ã£o completa)
  2. Verifique logs no console com filtro: [AM-FIX]
  3. Inspecione: window.__PIXEL_VALIDATION_RESULTS__
  4. Verifique: window.__FBQ_GUARD_LOGS__

Patch Version: 1.0.0
Data: 2025-10-09
Branch: cursor/refactor-meta-pixel-user-data-handling-60cb

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
